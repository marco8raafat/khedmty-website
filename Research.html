<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="logoCircle1.png">
  <title> الأبحاث</title>
  <style>
    :root {
    --primary: #233B6E;
    --secondary: #314d9f;
    --light: #f5f7fa;
    --success: #388e3c;
    --error: #d32f2f;
    --shadow: 0 2px 10px rgba(0,0,0,0.08);
    --border-radius: 8px;
    --transition: all 0.3s ease;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
    body {
     font-family: 'Cairo', sans-serif;
    background: linear-gradient(to bottom right, #eaf1ff, #dbe5ff);
    color: #222;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    direction: rtl;
    background-image: url('knesa.jpg'); 
    background-size: cover;       
    background-repeat: no-repeat; 
    background-attachment: fixed;  
    background-position: center;  
    }

    .navbar {
    background-color: var(--primary);
    color: white ;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  
  .nav-left .church-logo {
    height: 80px;
    border-radius: 8px;
    background: white;
    padding: 5px;
  }
  
  .nav-right {
    display: flex;
    gap: 20px;
  }
  
  .nav-link {
    color: white;
    text-decoration: none;
    font-weight: bold;
    transition: 0.3s;
    padding: 8px 12px;
    border-radius: 6px;
  }
  
  .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  .nav-link.active {
    background-color: rgba(255, 255, 255, 0.3);
  }

  /* Mobile menu toggle button */
  .menu-toggle {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.3s;
  }

  .menu-toggle:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
 .container {
      padding: 40px 0px;
      display: flex;
      justify-content: center;
    }

    .content-box {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      padding: 30px;
      width: 95%;
      max-width: 1000px;
      overflow: auto;
       max-width: 100%;
       max-height: 100%;
    }

    h2.page-title {
      color: #1c2f5c;
      font-size: 26px;
      margin-bottom: 20px;
      text-align: center;
      border-bottom: 2px solid #1c2f5c;
      padding-bottom: 10px;
      width: fit-content;
      margin-inline: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #1c2f5c;
      color: white;
    }

    td input[type="number"] {
      width: 60px;
      padding: 5px;
    }

    td input[type="datetime-local"] {
      width: 150px;
      padding: 5px;
      font-size: 12px;
    }

    table input {
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    table input:focus {
      outline: none;
      border-color: #1c2f5c;
      box-shadow: 0 0 3px rgba(28, 47, 92, 0.3);
    }

    footer {
    background-color: var(--primary);
    color: white;
    text-align: center;
    padding: 20px;
    font-size: 0.95em;
    margin-top: auto;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  }

  /* Updated mobile breakpoint for phones like 390x844 */
  @media (max-width: 480px) {
    .navbar {
      flex-direction: column;
      padding: 10px;
    }

    .nav-left {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .nav-left .church-logo {
      height: 60px;
    }

    .menu-toggle {
      display: block;
    }

    .nav-right {
      width: 100%;
      flex-direction: column;
      gap: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .nav-right.active {
      max-height: 300px;
    }

    .nav-link {
      width: 100%;
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0;
    }

    .nav-link:last-child {
      border-bottom: none;
    }

    .pdf-list {
      padding: 0 12px;
    }

    .content-box {
      padding: 20px;
      width: 98%;
    }

    h2.page-title {
      font-size: 22px;
    }

    table {
      font-size: 12px;
    }

    th, td {
      padding: 8px 4px;
    }

    td input[type="number"] {
      width: 50px;
      padding: 3px;
      font-size: 12px;
    }
  }

  /* Additional breakpoint for larger phones and small tablets */
  @media (min-width: 481px) and (max-width: 768px) {
    .navbar {
      flex-direction: column;
      padding: 10px;
    }

    .nav-left {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .nav-left .church-logo {
      height: 60px;
    }

    .menu-toggle {
      display: block;
    }

    .nav-right {
      width: 100%;
      flex-direction: column;
      gap: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .nav-right.active {
      max-height: 300px;
    }

    .nav-link {
      width: 100%;
      text-align: center;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0;
    }

    .nav-link:last-child {
      border-bottom: none;
    }

    .pdf-list {
      padding: 0 12px;
    }
  }

  html, body {
  overflow-x: auto;   
  overflow-y: auto;   
  max-width: 100%;
  max-height: 100%;
}
 .cross-background {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   pointer-events: none;
   z-index: 1;
   overflow: hidden;
  }
  .glowing-cross {
    font-size: 50px;
    color: white;
    opacity: 0.6;
    filter: drop-shadow(0 0 8px rgba(173, 216, 230, 0.4));
    transition: all 0.3s ease;
    position: absolute;
    top: 40px;
    left: 40px;
  }

 
.cross {
  position: absolute;
  width: 30px;
  height: 30px;
  animation: float 12s linear infinite;
  opacity: 0.7;
  filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.6));
}

.cross svg {
  width: 100%;
  height: 100%;
  fill: rgba(255, 255, 255, 0.265);
}

@keyframes float {
  0% {
    transform: translateY(100vh) scale(1);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    transform: translateY(-20vh) scale(1.3);
    opacity: 0;
  }
}   
#searchInput {
  width: 300px;      /* العرض */
  height: 40px;      /* الطول */
  font-size: 16px;   /* حجم الخط */
  padding: 5px 10px;
  margin: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

#filterColumn {
  width: 200px;
  height: 40px;
  font-size: 16px;
  padding: 5px 10px;
  margin: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}


</style>
</head>
<body>
<div class="cross-background"></div>
<nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    </div>
    <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="teacherDashboard.html" class="nav-link">لوحة التحكم</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">تسجيل الخروج</a>
    </div>
  </nav>

  <div class="container">
<div class="content-box">
      <h2 class="page-title">الأبحاث</h2>
  <input type="text" id="searchInput" placeholder="ابحث هنا..." style="width: 300px; height: 35px;" />

    <table id="researchTable">
     <thead>
      <tr>
        <th>رقم</th>
        <th>اسم الطالب</th>
        <th>المجموعة</th>
        <th>اسم البحث</th>
        <th>تاريخ التسليم</th>
        <th>الوقت</th>
        <th>البحث (PDF)</th>
        <th>تاريخ ووقت المناقشة</th>
        <th>درجة البحث </th>
        <th>درجة المناقشة </th>
        <th>اجمالي الدرجة</th>
      </tr>
     </thead>
     <tbody id="researchTableBody">
       <tr>
         <td colspan="11" style="text-align: center; padding: 20px;">جاري تحميل البيانات...</td>
       </tr>
     </tbody>
    </table>
      </div>
  </div>

  <footer>
    © كنيسة السيدة العذراء - عزبة النخل | تطبيق خدمتي 2025
  </footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
  authDomain: "edad-5odam.firebaseapp.com",
  databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "edad-5odam",
  storageBucket: "edad-5odam.appspot.com",
  messagingSenderId: "679576633778",
  appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Authentication and authorization functions
async function checkAuthentication() {
  const currentEmail = sessionStorage.getItem("currentUser");
  console.log("Current email from session:", currentEmail);
  
  if (!currentEmail) {
    alert("يرجى تسجيل الدخول أولاً للوصول إلى هذه الصفحة");
    window.location.href = "login.html";
    return false;
  }

  const emailKey = currentEmail.replace(/[.#$\[\]]/g, '_');
  
  try {
    const userSnapshot = await firebase.database().ref(`users/${emailKey}`).once('value');
    const userData = userSnapshot.val();
    
    if (!userData || Object.keys(userData).length === 0) {
      console.log("No user data found, redirecting to login");
      alert("لم يتم العثور على بيانات المستخدم. يرجى تسجيل الدخول مرة أخرى");
      window.location.href = "login.html";
      return false;
    }

    // Check if user is a servant/teacher
    if (!checkIfServant(userData)) {
      console.log("User is not a servant, access denied");
      alert("غير مسموح لك بالوصول إلى هذه الصفحة. هذه الصفحة مخصصة للخدام فقط");
      window.location.href = "login.html";
      return false;
    }

    console.log("User authenticated successfully as servant");
    return true;
    
  } catch (error) {
    console.error("Error checking authentication:", error);
    alert("حدث خطأ أثناء التحقق من الصلاحيات. يرجى المحاولة مرة أخرى");
    window.location.href = "login.html";
    return false;
  }
}

function checkIfServant(userData) {
  if (!userData || !userData.role) {
    console.log("No role found in user data");
    return false;
  }
  
  const userRole = userData.role.toLowerCase();
  const allowedRoles = ['teacher', 'servant', 'admin', 'خادم', 'معلم', 'مدير'];
  
  console.log("User role:", userRole);
  console.log("Checking against allowed roles:", allowedRoles);
  
  const isServant = allowedRoles.includes(userRole);
  console.log("Is servant:", isServant);
  
  return isServant;
}

// Legacy function for backward compatibility
function checkAuth() {
  const currentUser = sessionStorage.getItem("currentUser");
  if (!currentUser) {
    alert("يجب تسجيل الدخول أولاً للوصول إلى هذه الصفحة");
    window.location.href = "login.html";
    return null;
  }
  
  // Handle both string email and JSON object formats
  try {
    return JSON.parse(currentUser);
  } catch (e) {
    // If parsing fails, it's just an email string
    return { email: currentUser };
  }
}

// Logout function
    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        sessionStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }
    }

// Mobile menu toggle function
function toggleMobileMenu() {
  const navMenu = document.getElementById('navMenu');
  navMenu.classList.toggle('active');
}

// Close mobile menu when clicking on a link
document.addEventListener('DOMContentLoaded', function() {
  const navLinks = document.querySelectorAll('.nav-link');
  navLinks.forEach(link => {
    link.addEventListener('click', function() {
      const navMenu = document.getElementById('navMenu');
      navMenu.classList.remove('active');
    });
  });
});

// Load research data from Firebase
async function loadResearchData() {
  try {
    const snapshot = await db.ref('researches').once('value');
    const data = snapshot.val();
    const tableBody = document.getElementById('researchTableBody');
    
    if (!data) {
      tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">لا توجد أبحاث مسجلة</td></tr>';
      return;
    }

    // Convert data to array and sort by timestamp (newest first)
    const researches = Object.keys(data).map(key => ({
     id: key,
     ...data[key]
    })).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));


    // Clear loading message
    tableBody.innerHTML = '';

     // Populate table
     const reversed = [...researches].reverse();
     reversed.forEach((research, index) => {
      const row = document.createElement('tr');
      
      // Format submission date
      const submissionDate = research.submissionDate || 'غير محدد';
      const submissionTime = research.submissionTime || 'غير محدد';
      
      // Create research link
      const researchLink = research.researchLink ? 
        `<a href="${research.researchLink}" target="_blank" style="color: #233B6E; text-decoration: underline;">عرض البحث</a>` : 
        'غير متوفر';

      // Calculate total grade if both grades are available
      let totalGrade = research.totalGrade || '';
      if (!totalGrade && research.researchGrade && research.discussionGrade) {
        const researchScore = parseFloat(research.researchGrade) || 0;
        const discussionScore = parseFloat(research.discussionGrade) || 0;
        totalGrade = (researchScore + discussionScore).toString();
      }

      row.innerHTML = `
        <td>${researches.length - index}</td>
        <td>${research.studentName || 'غير محدد'}</td>
        <td>${research.team || 'غير محدد'}</td>
        <td>${research.researchTitle || 'غير محدد'}</td>
        <td>${submissionDate}</td>
        <td>${submissionTime}</td>
        <td>${researchLink}</td>
        <td><input type="datetime-local" value="${research.discussionDate || ''}" onchange="updateResearch('${research.id}', 'discussionDate', this.value)" /></td>
        <td><input type="number" min="0" max="100" value="${research.researchGrade || ''}" onchange="updateResearch('${research.id}', 'researchGrade', this.value)" /></td>
        <td><input type="number" min="0" max="100" value="${research.discussionGrade || ''}" onchange="updateResearch('${research.id}', 'discussionGrade', this.value)" /></td>
        <td style="font-weight: bold; background-color: #f0f8ff;">${totalGrade}</td>
      `;
      
      tableBody.appendChild(row);
    });

  } catch (error) {
    console.error("Error loading research data:", error);
    document.getElementById('researchTableBody').innerHTML = 
      '<tr><td colspan="11" style="text-align: center; padding: 20px; color: red;">حدث خطأ أثناء تحميل البيانات</td></tr>';
  }
}

// Update research data in Firebase
async function updateResearch(researchId, field, value) {
  try {
    await db.ref(`researches/${researchId}/${field}`).set(value);
    
    // If updating grades, recalculate total
    if (field === 'researchGrade' || field === 'discussionGrade') {
      const snapshot = await db.ref(`researches/${researchId}`).once('value');
      const research = snapshot.val();
      
      if (research.researchGrade && research.discussionGrade) {
        const total = (parseFloat(research.researchGrade) || 0) + (parseFloat(research.discussionGrade) || 0);
        await db.ref(`researches/${researchId}/totalGrade`).set(total.toString());
        
        // Update the display
        loadResearchData();
      }
    }
    
    console.log("Research updated successfully");
  } catch (error) {
    console.error("Error updating research:", error);
    alert("حدث خطأ أثناء حفظ التعديلات");
  }
}

const searchInput = document.getElementById("searchInput");
  const table = document.getElementById("researchTable");

  searchInput.addEventListener("input", function () {
    const searchValue = this.value.toLowerCase();
    const selectedColumn = "all";
    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
      const cells = rows[i].getElementsByTagName("td");
      let match = false;

      if (selectedColumn === "all") {
        for (let j = 0; j < cells.length; j++) {
          if (cells[j].innerText.toLowerCase().includes(searchValue)) {
            match = true;
            break;
          }
        }
      } else {
        const colIndex = parseInt(selectedColumn);
        if (
          cells[colIndex] &&
          cells[colIndex].innerText.toLowerCase().includes(searchValue)
        ) {
          match = true;
        }
      }

    rows[i].style.display = match ? "" : "none";
  }
});

// Initialize page when loaded
window.onload = async function() {
  const isAuthenticated = await checkAuthentication();
  if (isAuthenticated) {
    loadResearchData();
  }
};


 const container = document.querySelector('.cross-background');const svgCross = `
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
     viewBox="0 0 60 60" xml:space="preserve">
  <path d="M52.247,19.665c-0.396,0-0.785,0.049-1.162,0.145c-0.403-2.214-2.347-3.897-4.675-3.897
           c-2.396,0-4.382,1.781-4.707,4.087H35v-4.811c2.077-0.517,3.594-2.381,3.594-4.599
           c0-2.188-1.486-4.036-3.503-4.586c0.11-0.404,0.167-0.824,0.167-1.251C35.258,2.132,33.126,0,30.506,0
           c-2.621,0-4.753,2.132-4.753,4.753c0,0.395,0.049,0.785,0.145,1.162C23.684,6.318,22,8.262,22,10.59
           c0,2.364,1.735,4.331,4,4.693V20h-7.812c-0.516-2.077-2.38-3.594-4.599-3.594c-2.188,0-4.035,1.486-4.585,3.503
           c-0.405-0.11-0.825-0.167-1.252-0.167C5.132,19.742,3,21.874,3,24.495s2.132,4.753,4.753,4.753
           c0.396,0,0.785-0.049,1.162-0.145C9.318,31.316,11.262,33,13.59,33c2.365,0,4.332-1.736,4.693-4H26v15.84
           c-2.026,0.551-3.506,2.405-3.506,4.569c0,2.188,1.486,4.036,3.502,4.586c-0.11,0.405-0.167,0.825-0.167,1.252
           c0,2.621,2.132,4.752,4.753,4.752s4.753-2.132,4.753-4.752c0-0.395-0.049-0.785-0.146-1.162
           c2.215-0.404,3.898-2.347,3.898-4.676c0-2.395-1.781-4.382-4.088-4.706V29h6.84
           c0.552,2.027,2.406,3.506,4.57,3.506c2.188,0,4.035-1.486,4.585-3.503c0.405,0.11,0.825,0.167,1.252,0.167
           c2.621,0,4.753-2.132,4.753-4.752S54.868,19.665,52.247,19.665z"/>
</svg>
`;


 const isMobile = window.innerWidth < 768;
const crossCount = isMobile ? 10 : 25;

for (let i = 0; i < crossCount; i++) {
  const cross = document.createElement('div');
  cross.className = 'cross';
  cross.innerHTML = svgCross;
  cross.style.left = Math.random() * 100 + 'vw';
  cross.style.top = Math.random() * 100 + 'vh';
  cross.style.animationDuration = (12 + Math.random() * 11) + 's';
  container.appendChild(cross);
}

</script>
</body>
</html>