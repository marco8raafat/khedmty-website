<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="logoCircle1.png">
  <title>المصادر التعليمية</title>
  <style>
    :root {
      --primary: #233B6E;
      --secondary: #314d9f;
      --light: #f5f7fa;
      --success: #388e3c;
      --error: #d32f2f;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --border-radius: 10px;
      --transition: all 0.3s ease;
      --accent: #e3e9ff;
      --text-dark: #1a1a1a;
      --text-muted: #4a4a4a;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', 'Arial', sans-serif;
      background: linear-gradient(135deg, #e6edff 0%, #d4e0ff 100%);
      color: var(--text-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      direction: rtl;
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
      background-image: url('knesa.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
    }
    
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    /* Navigation Styles */
    .navbar {
      background-color: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    
    .nav-left {
      display: flex;
      align-items: center;
    }
    
    .nav-left .church-logo {
      height: 80px;
      border-radius: 8px;
      background: white;
      padding: 5px;
    }
    
    .nav-right {
      display: flex;
      gap: 20px;
    }
    
    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .nav-link.active {
      background-color: rgba(255, 255, 255, 0.3);
    }

    /* Hamburger menu toggle button */
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.3s;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
    }

    .menu-toggle:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    /* Hamburger lines */
    .hamburger-line {
      width: 25px;
      height: 3px;
      background-color: white;
      margin: 3px 0;
      transition: 0.3s;
      border-radius: 2px;
    }

    /* Animation for hamburger when active */
    .menu-toggle.active .hamburger-line:nth-child(1) {
      transform: rotate(-45deg) translate(-5px, 6px);
    }

    .menu-toggle.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }

    .menu-toggle.active .hamburger-line:nth-child(3) {
      transform: rotate(45deg) translate(-5px, -6px);
    }

    /* Main Content */
    main {
      flex: 1;
      padding: 32px 0;
    }
    
    .section-title {
      color: var(--primary);
      text-align: center;
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 24px;
      position: relative;
      padding-bottom: 16px;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      border-radius: 2px;
    }
    
    /* Filter Group */
    .filter-group {
      max-width: 90%;
      margin: 0 auto 24px auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filter-group label {
      font-weight: 700;
      font-size: 1em;
      color: var(--primary);
    }
    
    .filter-group select {
      padding: 12px 16px;
      border: 1px solid #c5cee8;
      border-radius: var(--border-radius);
      font-size: 1em;
      background: var(--accent);
      font-family: 'Cairo', 'Arial', sans-serif;
      direction: rtl;
      transition: var(--transition);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
      cursor: pointer;
    }
    
    .filter-group select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 6px rgba(49, 77, 159, 0.3);
    }
    
    /* PDF List */
    .pdf-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 24px;
      padding: 0 8px;
      max-width: 1280px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .pdf-item {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid rgba(35, 59, 110, 0.08);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .pdf-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(35, 59, 110, 0.15);
    }
    
    .pdf-title {
      font-size: 1.1em;
      color: var(--primary);
      font-weight: 600;
      direction: rtl;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .pdf-subject {
      font-size: 0.9em;
      color: var(--text-muted);
      font-weight: 500;
      background: var(--accent);
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 10px;
    }
    
    .pdf-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: auto;
    }
    
    .pdf-actions a {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 12px 24px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 1em;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      flex: 1;
      text-align: center;
      min-height: 44px;
      touch-action: manipulation;
    }
    
    .pdf-actions a:hover {
      background: linear-gradient(135deg, #1a2d59, var(--primary));
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .pdf-actions a:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(49, 77, 159, 0.3);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin: 24px auto;
      max-width: 600px;
      grid-column: 1 / -1;
    }
    
    .empty-state p {
      font-size: 1.2em;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.5;
    }

    /* Loading state */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Footer */
    footer {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 0.95em;
      margin-top: auto;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }
    
    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      .navbar {
        flex-wrap: wrap;
        padding: 10px 15px;
      }

      .nav-left {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-left .church-logo {
        height: 60px;
      }

      .menu-toggle {
        display: flex;
      }

      .nav-right {
        width: 100%;
        flex-direction: column;
        gap: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 0 0 8px 8px;
        order: 3;
      }

      .nav-right.active {
        max-height: 350px;
        margin-top: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .nav-link {
        width: 100%;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .nav-link:hover,
      .nav-link:active {
        background-color: rgba(255, 255, 255, 0.15);
        transform: scale(0.98);
      }

      .nav-link:last-child {
        border-bottom: none;
      }

      .container {
        padding: 0 12px;
      }
    
      main {
        padding: 24px 0;
      }
    
      .section-title {
        font-size: 1.6em;
        margin-bottom: 20px;
        padding-bottom: 12px;
      }
    
      .section-title::after {
        width: 60px;
      }
    
      .filter-group {
        max-width: 100%;
        margin: 0 auto 20px auto;
        padding: 0 8px;
      }
    
      .filter-group label {
        font-size: 0.95em;
      }
    
      .filter-group select {
        padding: 12px 14px;
        font-size: 0.95em;
      }
    
      .pdf-list {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        padding: 0 8px;
      }
    
      .pdf-item {
        padding: 16px;
        gap: 12px;
      }
    
      .pdf-title {
        font-size: 1em;
        line-height: 1.3;
      }

      .pdf-subject {
        font-size: 0.85em;
      }
    
      .pdf-actions {
        gap: 10px;
      }
    
      .pdf-actions a {
        padding: 10px 16px;
        font-size: 0.9em;
        min-height: 40px;
      }
    
      .empty-state {
        margin: 20px auto;
        padding: 30px 16px;
        max-width: 90%;
      }
    
      .empty-state p {
        font-size: 1.1em;
      }
    }
    
    @media (max-width: 480px) {
      .navbar {
        padding: 8px 10px;
      }

      .nav-left .church-logo {
        height: 50px;
      }

      .menu-toggle {
        width: 36px;
        height: 36px;
      }

      .hamburger-line {
        width: 22px;
        height: 2px;
      }

      .container {
        padding: 0 8px;
      }
    
      .pdf-list {
        grid-template-columns: 1fr;
        gap: 12px;
        padding: 0 4px;
      }
    
      .pdf-item {
        padding: 14px;
        gap: 10px;
      }

      .pdf-title {
        font-size: 0.95em;
      }

      .pdf-subject {
        font-size: 0.8em;
      }
    
      .filter-group select {
        font-size: 0.9em;
        padding: 10px 12px;
      }
    
      .pdf-actions a {
        font-size: 0.85em;
        padding: 10px 12px;
        min-height: 38px;
      }
    
      .section-title {
        font-size: 1.4em;
      }
    
      .empty-state p {
        font-size: 1em;
      }
    }
    
    @media (max-width: 360px) {
      .container {
        padding: 0 6px;
      }
    
      .pdf-list {
        gap: 10px;
      }
    
      .pdf-item {
        padding: 12px;
      }
    
      .pdf-actions a {
        font-size: 0.8em;
        padding: 8px 10px;
        min-height: 36px;
      }
    
      .filter-group {
        margin: 0 auto 16px auto;
        padding: 0 4px;
      }
    
      .filter-group select {
        padding: 8px 10px;
        font-size: 0.85em;
      }

      .section-title {
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" id="menuToggle" aria-label="قائمة التنقل" aria-expanded="false">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
      </button>
    </div>
    <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="studentDashboard.html" class="nav-link">لوحة التحكم</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">تسجيل الخروج</a>
    </div>
  </nav>

  <div class="container">
    <main>
      <h2 class="section-title">المصادر التعليمية المرفوعة</h2>
      <div class="filter-group">
        <label for="subjectFilter">تصفية حسب المادة:</label>
        <select id="subjectFilter">
          <option value="all">الكل</option>
        </select>
      </div>
      <div id="pdfList" class="pdf-list">
        <div class="empty-state">
          <p>جاري تحميل المصادر التعليمية... <span class="loading-spinner"></span></p>
        </div>
      </div>
    </main>
  </div>

  <footer>
    © كنيسة السيدة العذراء - عزبة النخل | تطبيق خدمتي 2025
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
      authDomain: "edad-5odam.firebaseapp.com",
      databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "edad-5odam",
      storageBucket: "edad-5odam.appspot.com",
      messagingSenderId: "679576633778",
      appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Smart Cache Management System for Student PDFs
    class StudentPDFCache {
      constructor() {
        this.cache = new Map();
        this.listeners = new Map();
        this.lastUpdated = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5 minutes cache expiry
      }

      // Check if cached data is still valid
      isCacheValid(path) {
        const lastUpdate = this.lastUpdated.get(path);
        if (!lastUpdate) return false;
        return (Date.now() - lastUpdate) < this.cacheExpiry;
      }

      // Get data from cache or Firebase with real-time listener
      async getData(path, callback) {
        // If we have valid cached data, use it immediately
        if (this.isCacheValid(path) && this.cache.has(path)) {
          console.log(`[Student PDFs] Using cached data for ${path}`);
          if (callback) callback(this.cache.get(path));
          return this.cache.get(path);
        }

        // Set up real-time listener if not already exists
        if (!this.listeners.has(path)) {
          console.log(`[Student PDFs] Setting up real-time listener for ${path}`);
          const listener = db.ref(path).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            this.cache.set(path, data);
            this.lastUpdated.set(path, Date.now());
            console.log(`[Student PDFs] Data updated for ${path}:`, Object.keys(data).length, 'PDFs');
            if (callback) callback(data);
          });
          this.listeners.set(path, listener);
        }

        // Return cached data if available, otherwise return empty object
        return this.cache.get(path) || {};
      }

      // Clean up listeners when not needed
      cleanup() {
        this.listeners.forEach((listener, path) => {
          db.ref(path).off('value', listener);
        });
        this.listeners.clear();
        this.cache.clear();
        this.lastUpdated.clear();
      }
    }

    // Initialize cache instance
    const studentPDFCache = new StudentPDFCache();

    // Debounce function to prevent rapid successive updates
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Logout function
    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        sessionStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }
    }

    // Hamburger menu functionality
    document.addEventListener('DOMContentLoaded', function() {
      const menuToggle = document.getElementById('menuToggle');
      const navMenu = document.getElementById('navMenu');
      const navLinks = document.querySelectorAll('.nav-link');
      const pdfList = document.getElementById('pdfList');
      const subjectFilter = document.getElementById('subjectFilter');

      // Toggle mobile menu
      menuToggle.addEventListener('click', function() {
        navMenu.classList.toggle('active');
        menuToggle.classList.toggle('active');
        
        // Update aria-expanded for accessibility
        const isExpanded = navMenu.classList.contains('active');
        menuToggle.setAttribute('aria-expanded', isExpanded);
      });

      // Close mobile menu when clicking on a link
      navLinks.forEach(link => {
        link.addEventListener('click', function() {
          navMenu.classList.remove('active');
          menuToggle.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', function(event) {
        const isClickInsideNav = navMenu.contains(event.target) || menuToggle.contains(event.target);
        
        if (!isClickInsideNav && navMenu.classList.contains('active')) {
          navMenu.classList.remove('active');
          menuToggle.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });

      // Close menu on window resize if screen becomes larger
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          navMenu.classList.remove('active');
          menuToggle.classList.remove('active');
          menuToggle.setAttribute('aria-expanded', 'false');
        }
      });

      // PDF List functionality
      if (!pdfList || !subjectFilter) {
        console.error('Required elements missing:', {
          pdfList: !!pdfList,
          subjectFilter: !!subjectFilter
        });
        return;
      }

      // Check if Firebase is available
      if (typeof firebase === 'undefined' || !firebase.database) {
        console.error('Firebase not available');
        displayEmptyState();
        return;
      }

      let allPdfs = [];

      // Fetch PDFs from Firebase with smart caching
      const debouncedProcessPDFs = debounce(processPDFData, 200);
      
      function fetchPDFs() {
        displayLoading();
        
        // Use smart caching for educational resources
        studentPDFCache.getData('educational-resources', (data) => {
          debouncedProcessPDFs(data);
        });
      }

      // Process PDF data from cache or Firebase
      function processPDFData(data) {
        allPdfs = [];
        
        if (data && Object.keys(data).length > 0) {
          Object.values(data).forEach((pdf) => {
            if (pdf) {
              allPdfs.push(pdf);
            }
          });
          
          console.log('[Student PDFs] Processed PDFs:', allPdfs.length);
          populateSubjectFilter();
          renderPDFs('all');
        } else {
          console.log('[Student PDFs] No educational resources found');
          displayEmptyState();
        }
      }

      // Populate subject filter dropdown
      function populateSubjectFilter() {
        const subjects = [...new Set(allPdfs.map(pdf => pdf.subject || 'غير محدد'))].sort();
        
        // Clear existing options except "All"
        subjectFilter.innerHTML = '<option value="all">الكل</option>';
        
        subjects.forEach(subject => {
          const option = document.createElement('option');
          option.value = subject;
          option.textContent = subject;
          subjectFilter.appendChild(option);
        });
      }

      // Debounced render function for smooth filtering
      const debouncedRender = debounce((filterSubject) => {
        renderPDFs(filterSubject);
      }, 200);

      // Display PDFs based on filter (students can only view, not delete)
      function renderPDFs(filterSubject) {
        pdfList.innerHTML = ''; // Clear current list
        const filteredPDFs = filterSubject === 'all' ? allPdfs : allPdfs.filter(pdf => (pdf.subject || 'غير محدد') === filterSubject);

        if (filteredPDFs.length === 0) {
          displayEmptyState();
          return;
        }

        filteredPDFs.forEach(pdf => {
          const pdfItem = document.createElement('div');
          pdfItem.className = 'pdf-item';

          const pdfTitle = document.createElement('div');
          pdfTitle.className = 'pdf-title';
          pdfTitle.textContent = pdf.title;

          const pdfSubject = document.createElement('div');
          pdfSubject.className = 'pdf-subject';
          pdfSubject.textContent = `المادة: ${pdf.subject || 'غير محدد'}`;

          const pdfActions = document.createElement('div');
          pdfActions.className = 'pdf-actions';

          // View button (only action for students)
          const viewLink = document.createElement('a');
          viewLink.href = pdf.link; // Use the link from Firebase
          viewLink.textContent = 'عرض المصدر';
          viewLink.setAttribute('target', '_blank'); // Open in new tab
          viewLink.setAttribute('rel', 'noopener noreferrer'); // Security

          pdfActions.appendChild(viewLink);
          pdfItem.appendChild(pdfTitle);
          pdfItem.appendChild(pdfSubject);
          pdfItem.appendChild(pdfActions);
          pdfList.appendChild(pdfItem);
        });
      }

      // Initial load
      fetchPDFs();

      // Filter change event with debouncing
      subjectFilter.addEventListener('change', (e) => {
        console.log('[Student PDFs] Filtering by subject:', e.target.value);
        debouncedRender(e.target.value);
      });

      // Clean up cache and listeners when page is about to unload
      window.addEventListener('beforeunload', () => {
        studentPDFCache.cleanup();
      });

      function displayLoading() {
        pdfList.innerHTML = `
          <div class="empty-state">
            <p>جاري تحميل المصادر التعليمية... <span class="loading-spinner"></span></p>
          </div>
        `;
        console.log('Displayed loading state');
      }

      function displayEmptyState() {
        pdfList.innerHTML = `
          <div class="empty-state">
            <p>لا توجد مصادر تعليمية مرفوعة حاليًا</p>
          </div>
        `;
        console.log('Displayed empty state');
      }
    });
  </script>
</body>
</html>