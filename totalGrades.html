<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="logoCircle1.png">
  <title>Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø®Ø¯Ù…ØªÙŠ</title>
  <style>
    :root {
      --primary: #233B6E;
      --secondary: #314d9f;
      --light: #f5f7fa;
      --success: #388e3c;
      --error: #d32f2f;
      --warning: #f57c00;
      --shadow: 0 2px 10px rgba(0,0,0,0.08);
      --border-radius: 8px;
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background-image: url('knesa.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      direction: rtl;
    }

    .navbar {
      background-color: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1000;
    }
    
    .nav-left .church-logo {
      height: 60px;
      border: 3px solid #fff;
      border-radius: 12px;
      padding: 4px;
      background-color: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .nav-right {
      display: flex;
      gap: 20px;
    }
    
    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .menu-toggle:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .container {
      max-width: 1400px;
      margin: 20px auto;
      background-color: white;
      border-radius: 15px;
      box-shadow: var(--shadow);
      padding: 30px;
      flex: 1;
    }

    .header-section {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: var(--border-radius);
    }

    .header-section h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header-section p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .search-controls {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }

    .search-group {
      display: flex;
      flex-direction: column;
    }

    .search-group label {
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .search-input, .filter-select {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-input:focus, .filter-select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(35, 59, 110, 0.1);
    }

    .search-btn, .clear-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
    }

    .search-btn {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .clear-btn {
      background: var(--warning);
      color: white;
    }

    .clear-btn:hover {
      background: #e65100;
    }

    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .stat-label {
      color: #666;
      font-weight: bold;
    }

    .table-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table-header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h3 {
      font-size: 1.3em;
    }

    .results-info {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .table-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }

    .grades-table {
      width: 100%;
      border-collapse: collapse;
    }

    .grades-table th {
      background: var(--primary);
      color: white;
      padding: 15px 12px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .grades-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }

    .grades-table tbody tr {
      transition: var(--transition);
    }

    .grades-table tbody tr:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
    }

    .grades-table tbody tr:nth-child(even) {
      background-color: rgba(35, 59, 110, 0.02);
    }

    .student-name {
      font-weight: bold;
      color: var(--primary);
    }

    .team-badge {
      background: var(--secondary);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: bold;
    }

    .grade-cell {
      font-weight: bold;
      font-size: 1.1em;
    }

    .grade-excellent {
      color: var(--success);
      background: rgba(56, 142, 60, 0.1);
    }

    .grade-good {
      color: #2196f3;
      background: rgba(33, 150, 243, 0.1);
    }

    .grade-average {
      color: var(--warning);
      background: rgba(245, 124, 0, 0.1);
    }

    .grade-poor {
      color: var(--error);
      background: rgba(211, 47, 47, 0.1);
    }

    .status-pass {
      color: var(--success);
      font-weight: bold;
      background: rgba(56, 142, 60, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .status-fail {
      color: var(--error);
      font-weight: bold;
      background: rgba(211, 47, 47, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #666;
    }

    .empty-state h3 {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: var(--primary);
    }

    footer {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 0.95em;
      margin-top: auto;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }

    .cross-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .cross {
      position: absolute;
      width: 30px;
      height: 30px;
      animation: float 12s linear infinite;
      opacity: 0.7;
      filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.6));
    }

    .cross svg {
      width: 100%;
      height: 100%;
      fill: rgba(255, 255, 255, 0.265);
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) scale(1);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      100% {
        transform: translateY(-20vh) scale(1.3);
        opacity: 0;
      }
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        padding: 10px;
      }

      .nav-left {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .nav-left .church-logo {
        height: 50px;
      }

      .menu-toggle {
        display: block;
      }

      .nav-right {
        width: 100%;
        flex-direction: column;
        gap: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .nav-right.active {
        max-height: 300px;
      }

      .nav-link {
        width: 100%;
        text-align: center;
        padding: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .container {
        margin: 10px;
        padding: 15px;
      }

      .header-section h1 {
        font-size: 1.8em;
      }

      .search-controls {
        grid-template-columns: 1fr;
      }

      .stats-section {
        grid-template-columns: repeat(2, 1fr);
      }

      .grades-table {
        font-size: 0.9em;
      }

      .grades-table th,
      .grades-table td {
        padding: 8px 4px;
        font-size: 0.8em;
      }
    }
  </style>
</head>
<body>
<div class="cross-background"></div>

<nav class="navbar">
  <div class="nav-left">
    <img src="church-logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒÙ†ÙŠØ³Ø©" class="church-logo">
    <button class="menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
  </div>
  <div class="nav-right" id="navMenu">
    <a href="index.html" class="nav-link">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="teacherDashboard.html" class="nav-link">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    <a href="javascript:void(0)" onclick="logout()" class="nav-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</nav>

<div class="container">
  <div class="header-section">
    <h1>ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    <p>Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ø¯Ø±Ø¬Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</p>
  </div>

  <div class="search-controls">
    <div class="search-group" style="grid-column: 1 / -1;">
      <label for="universalSearch">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„</label>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="universalSearch" class="search-input" 
               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ØŒ Ø§Ù„ÙØ±ÙŠÙ‚ØŒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø£Ùˆ Ø§Ù„Ø¯Ø±Ø¬Ø©..." 
               style="flex: 1;">
        <button class="search-btn" onclick="performUniversalSearch()" title="Ø¨Ø­Ø«">ğŸ” Ø¨Ø­Ø«</button>
      </div>
      <p style="font-size: 0.9em; color: #666; margin-top: 5px;">
        ğŸ” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø£ÙŠ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø±Ù‚Ù… ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      </p>
    </div>
  </div>

  <div class="stats-section" id="statsSection">
    <div class="stat-card">
      <div class="stat-number" id="totalRecords">-</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalStudents">-</div>
      <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalSubjects">-</div>
      <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="averageGrade">-</div>
      <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-header">
      <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
      <span class="results-info" id="resultsInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>

    <div id="loadingState" class="loading">
      <div class="loading-spinner"></div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª...</p>
    </div>

    <div id="tableContent" style="display: none;">
      <div class="table-wrapper">
        <table class="grades-table">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
              <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
              <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
              <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
              <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody id="gradesTableBody">
            <!-- Dynamic content will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <h3>ğŸ“Š Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
      <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</p>
      <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</p>
    </div>
  </div>
</div>

<footer>
  Â© ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø³ÙŠØ¯Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ - Ø¹Ø²Ø¨Ø© Ø§Ù„Ù†Ø®Ù„ | ØªØ·Ø¨ÙŠÙ‚ Ø®Ø¯Ù…ØªÙŠ 2025
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="sessionUtils.js"></script>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
    authDomain: "edad-5odam.firebaseapp.com",
    databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "edad-5odam",
    storageBucket: "edad-5odam.appspot.com",
    messagingSenderId: "679576633778",
    appId: "1:679576633778:web:566e6aaef9b72f71a824ab",
    measurementId: "G-7WB1WPDLRH"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Global variables
  let allGradesData = [];
  let filteredGradesData = [];
  let usersData = {};

  // Authentication and authorization functions
  async function checkAuthentication() {
    const currentEmail = await requireAuthentication("login.html");
    console.log("Current email from session:", currentEmail);
    
    if (!currentEmail) {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
      window.location.href = "login.html";
      return false;
    }

    const emailKey = currentEmail.replace(/[.#$\[\]]/g, '_');
    
    try {
      const userSnapshot = await firebase.database().ref(`users/${emailKey}`).once('value');
      const userData = userSnapshot.val();
      
      if (!userData || Object.keys(userData).length === 0) {
        console.log("No user data found, redirecting to login");
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
        window.location.href = "login.html";
        return false;
      }

      // Check if user is a servant/teacher
      if (!checkIfServant(userData)) {
        console.log("User is not a servant, access denied");
        alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø®Ø¯Ø§Ù… ÙÙ‚Ø·");
        window.location.href = "login.html";
        return false;
      }

      console.log("User authenticated successfully as servant");
      return true;
      
    } catch (error) {
      console.error("Error checking authentication:", error);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
      window.location.href = "login.html";
      return false;
    }
  }

  function checkIfServant(userData) {
    if (!userData || !userData.role) {
      console.log("No role found in user data");
      return false;
    }
    
    const userRole = userData.role.toLowerCase();
    const allowedRoles = ['teacher', 'servant', 'admin', 'Ø®Ø§Ø¯Ù…', 'Ù…Ø¹Ù„Ù…', 'Ù…Ø¯ÙŠØ±'];
    
    console.log("User role:", userRole);
    console.log("Checking against allowed roles:", allowedRoles);
    
    const isServant = allowedRoles.includes(userRole);
    console.log("Is servant:", isServant);
    
    return isServant;
  }

  // Legacy function for backward compatibility
  function checkAuth() {
    const currentUser = verifySecureSession();
    if (!currentUser) {
      alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  // Mobile menu toggle
  function toggleMobileMenu() {
    const navMenu = document.getElementById('navMenu');
    navMenu.classList.toggle('active');
  }

  // Logout function
  function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      clearSession();
      window.location.href = "index.html";
    }
  }

  // Get grade class based on grade value and status
  function getGradeClass(grade, status) {
    const numGrade = parseFloat(grade);
    if (isNaN(numGrade)) return '';
    
    // Check if student passed - if so, don't mark as poor even with low grade
    const isPassed = status && (
      status.toLowerCase().includes('Ù†Ø§Ø¬Ø­') || 
      status.toLowerCase().includes('Ù†Ø¬Ø­') || 
      status.toLowerCase().includes('pass')
    );
    
    if (numGrade >= 45) return 'grade-excellent';
    if (numGrade >= 40) return 'grade-good';
    if (numGrade >= 30) return 'grade-average';
    if (numGrade < 30 && !isPassed) return 'grade-poor';
  }

  // Get status class based on status text
  function getStatusClass(status) {
    if (!status) return '';
    
    const statusLower = status.toLowerCase();
    if (statusLower.includes('Ù†Ø§Ø¬Ø­') || statusLower.includes('Ù†Ø¬Ø­') || statusLower.includes('pass')) {
      return 'status-pass';
    } else if (statusLower.includes('Ø±Ø§Ø³Ø¨') || statusLower.includes('fail')) {
      return 'status-fail';
    }
    return '';
  }

  // Load users data from Firebase
  async function loadUsersData() {
    try {
      const snapshot = await database.ref('users').once('value');
      const users = snapshot.val() || {};
      
      // Convert Firebase data to usable format
      Object.keys(users).forEach(emailKey => {
        const email = emailKey.replace(/_/g, '.');
        usersData[email] = users[emailKey];
        
      });
      
      console.log("[Total Grades] Loaded users data:", Object.keys(usersData).length, "users");
    } catch (error) {
      console.error("[Total Grades] Error loading users data:", error);
    }
  }

  // Get team name for a user
  function getUserTeam(email, name) {
    // First try to get team from Firebase users data by email
    if (usersData[email]) {
      const userData = usersData[email];
      // Check all possible team field names in order of preference
      return userData.group || userData.team || userData.class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    }
    
    // If not found by email, try to find by name match
    for (const userEmail in usersData) {
      const userData = usersData[userEmail];
      if (userData.username === name || userData.name === name) {
        return userData.group || userData.team || userData.class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      }
    }
    
    return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  }

  // Load grades data from Google Sheets
  async function loadGradesData() {
    console.log("[Total Grades] Loading grades data...");
    
    const loadingState = document.getElementById('loadingState');
    const tableContent = document.getElementById('tableContent');
    const emptyState = document.getElementById('emptyState');

    try {
      // First load users data
      await loadUsersData();
      
      // Then load grades data
      const response = await fetch('https://script.google.com/macros/s/AKfycbyWbp6mp9l7djfsSc75eLDWaH8PYED0lOgZsEObfqtRCyxFqG5iMJnXtKqgWpYnWzUs/exec');
      const data = await response.json();
      
      console.log("[Total Grades] Raw data received:", data.length, "records");
      
      // Process and clean the data
      allGradesData = data.map(entry => {
        const studentEmail = (entry["Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"] || "").trim();
        const studentName = (entry["Ø§Ù„Ø§Ø³Ù…"] || "").trim();
        const team = getUserTeam(studentEmail, studentName);
        
        return {
          studentName: studentName,
          studentEmail: studentEmail,
          team: team,
          subject: (entry["Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ù‡"] || entry["Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©"] || "").trim(),
          grade: (entry["Ø§Ù„Ø¯Ø±Ø¬Ø©"] || "").toString().trim(),
          status: (entry["Ø§Ù„Ø­Ø§Ù„Ø©"] || "").trim()
        };
      }).filter(entry => 
        entry.studentName && entry.studentEmail && entry.subject
      );
      
      filteredGradesData = [...allGradesData];
      
      console.log("[Total Grades] Processed data:", allGradesData.length, "valid records");
      
      if (allGradesData.length === 0) {
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        tableContent.style.display = 'none';
        return;
      }
      
      displayGrades();
      updateStats();
      
      loadingState.style.display = 'none';
      tableContent.style.display = 'block';
      
    } catch (error) {
      console.error("[Total Grades] Error loading grades data:", error);
      loadingState.style.display = 'none';
      emptyState.style.display = 'block';
      
      // Show error message
      document.querySelector('#emptyState h3').textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      document.querySelector('#emptyState p').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
    }
  }

  // Display grades in the table
  function displayGrades() {
    const tableBody = document.getElementById('gradesTableBody');
    const resultsInfo = document.getElementById('resultsInfo');
    
    tableBody.innerHTML = '';
    
    if (filteredGradesData.length === 0) {
      document.getElementById('tableContent').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      return;
    }
    
    document.getElementById('tableContent').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
    
    filteredGradesData.forEach((grade, index) => {
      const row = document.createElement('tr');
      
      const gradeClass = getGradeClass(grade.grade, grade.status);
      const statusClass = getStatusClass(grade.status);
      
      row.innerHTML = `
        <td class="student-name">${grade.studentName}</td>
        <td style="font-size: 0.9em; color: #666;">${grade.studentEmail}</td>
        <td><span class="team-badge">${grade.team}</span></td>
        <td style="font-weight: bold;">${grade.subject}</td>
        <td class="grade-cell ${gradeClass}">${grade.grade || '-'}</td>
        <td><span class="${statusClass}">${grade.status || '-'}</span></td>
      `;
      
      tableBody.appendChild(row);
    });
    
    resultsInfo.textContent = `Ø¹Ø±Ø¶ ${filteredGradesData.length} Ù…Ù† ${allGradesData.length} Ø³Ø¬Ù„`;
  }

  // Update statistics
  function updateStats() {
    const totalRecords = document.getElementById('totalRecords');
    const totalStudents = document.getElementById('totalStudents');
    const totalSubjects = document.getElementById('totalSubjects');
    const averageGrade = document.getElementById('averageGrade');
    
    // Calculate statistics
    const uniqueStudents = new Set(allGradesData.map(grade => grade.studentEmail)).size;
    const uniqueSubjects = new Set(allGradesData.map(grade => grade.subject)).size;
    
    // Calculate average grade
    const validGrades = allGradesData
      .map(grade => parseFloat(grade.grade))
      .filter(grade => !isNaN(grade));
    
    const avgGrade = validGrades.length > 0 
      ? (validGrades.reduce((sum, grade) => sum + grade, 0) / validGrades.length).toFixed(1)
      : '-';
    
    // Update DOM
    totalRecords.textContent = allGradesData.length.toLocaleString('ar-EG');
    totalStudents.textContent = uniqueStudents.toLocaleString('ar-EG');
    totalSubjects.textContent = uniqueSubjects.toLocaleString('ar-EG');
    averageGrade.textContent = avgGrade !== '-' ? avgGrade + '%' : '-';
  }

  // Perform universal search across all fields
  function performUniversalSearch() {
    const searchTerm = document.getElementById('universalSearch').value.toLowerCase().trim();
    
    if (!searchTerm) {
      // If search is empty, show all data
      filteredGradesData = [...allGradesData];
      displayGrades();
      return;
    }
    
    console.log("[Total Grades] Performing universal search for:", searchTerm);
    
    filteredGradesData = allGradesData.filter(grade => {
      // Search across all fields
      const searchableFields = [
        grade.studentName,
        grade.studentEmail,
        grade.team,
        grade.subject,
        grade.grade,
        grade.status
      ];
      
      // Check if search term matches any field
      return searchableFields.some(field => 
        field && field.toLowerCase().includes(searchTerm)
      );
    });
    
    console.log("[Total Grades] Universal search results:", filteredGradesData.length, "records");
    displayGrades();
  }

  // Clear search
  function clearSearch() {
    document.getElementById('universalSearch').value = '';
    filteredGradesData = [...allGradesData];
    displayGrades();
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', async function() {
    console.log("[Total Grades] Initializing page...");
    
    const isAuthenticated = await checkAuthentication();
    if (!isAuthenticated) {
      return;
    }
    
    // Load initial data
    loadGradesData();
    
    // Add event listener for universal search
    const universalSearch = document.getElementById('universalSearch');
    if (universalSearch) {
      // Real-time search as user types
      universalSearch.addEventListener('input', function() {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(performUniversalSearch, 300);
      });
      
      // Search on Enter key press
      universalSearch.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performUniversalSearch();
        }
      });
    }
  });

  // Cross background animation
  const container = document.querySelector('.cross-background');
  const svgCross = `
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px"
         viewBox="0 0 60 60" xml:space="preserve">
      <path d="M52.247,19.665c-0.396,0-0.785,0.049-1.162,0.145c-0.403-2.214-2.347-3.897-4.675-3.897
               c-2.396,0-4.382,1.781-4.707,4.087H35v-4.811c2.077-0.517,3.594-2.381,3.594-4.599
               c0-2.188-1.486-4.036-3.503-4.586c0.11-0.404,0.167-0.824,0.167-1.251C35.258,2.132,33.126,0,30.506,0
               c-2.621,0-4.753,2.132-4.753,4.753c0,0.395,0.049,0.785,0.145,1.162C23.684,6.318,22,8.262,22,10.59
               c0,2.364,1.735,4.331,4,4.693V20h-7.812c-0.516-2.077-2.38-3.594-4.599-3.594c-2.188,0-4.035,1.486-4.585,3.503
               c-0.405-0.11-0.825-0.167-1.252-0.167C5.132,19.742,3,21.874,3,24.495s2.132,4.753,4.753,4.753
               c0.396,0,0.785-0.049,1.162-0.145C9.318,31.316,11.262,33,13.59,33c2.365,0,4.332-1.736,4.693-4H26v15.84
               c-2.026,0.551-3.506,2.405-3.506,4.569c0,2.188,1.486,4.036,3.502,4.586c-0.11,0.405-0.167,0.825-0.167,1.252
               c0,2.621,2.132,4.752,4.753,4.752s4.753-2.132,4.753-4.752c0-0.395-0.049-0.785-0.146-1.162
               c2.215-0.404,3.898-2.347,3.898-4.676c0-2.395-1.781-4.382-4.088-4.706V29h6.84
               c0.552,2.027,2.406,3.506,4.57,3.506c2.188,0,4.035-1.486,4.585-3.503c0.405,0.11,0.825,0.167,1.252,0.167
               c2.621,0,4.753-2.132,4.753-4.752S54.868,19.665,52.247,19.665z"/>
    </svg>
  `;

  const isMobile = window.innerWidth < 768;
  const crossCount = isMobile ? 10 : 25;

  for (let i = 0; i < crossCount; i++) {
    const cross = document.createElement('div');
    cross.className = 'cross';
    cross.innerHTML = svgCross;
    cross.style.left = Math.random() * 100 + 'vw';
    cross.style.top = Math.random() * 100 + 'vh';
    cross.style.animationDuration = (12 + Math.random() * 11) + 's';
    container.appendChild(cross);
  }
</script>

</body>
</html>
