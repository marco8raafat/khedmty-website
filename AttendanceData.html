<!DOCTYPE html>
<html lang="ar"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styleAttendance.css">
  <title>تسجيل الحضور </title>
</head>
<body>
    <style>
      .controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.controls > * {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px;
  flex: 1 1 200px;
  box-sizing: border-box;
}

.date-picker label,
.search-box label {
  white-space: nowrap;
  font-size: 14px;
  line-height: 1; 
}

.date-picker input,
.search-box input {
  flex: 1;
  padding: 5px 10px;
  font-size: 14px;
  line-height: 1.5;
}

.btn {
  padding: 8px 12px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
  justify-content: center;
  align-items: center;
  display: flex;
}

.btn-primary {
  background-color: var(--primary, #233B6E);
  color: white;
  border: none;
  border-radius: 4px;
}

.btn-success {
  background-color: var(--success, #4CAF50);
  color: white;
  border: none;
  border-radius: 4px;
}
.alert {
  display: none;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
  font-weight: bold;
  transition: all 0.3s ease-in-out;
}

.success {
  background-color: #d4edda;
  color: #155724;
}

.error {
  background-color: #f8d7da;
  color: #721c24;
}

          </style>

  <nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    </div>
    <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="teacherDashboard.html" class="nav-link">لوحة التحكم</a>
      <a href="AttendanceData.html" class="nav-link">أخذ الحضور</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">تسجيل الخروج</a>
    </div>
  </nav>
      <div class="container">
        <div class="header">
          <h2>تسجيل الحضور</h2>
        </div>

        <div class="controls">
            <div class="date-picker">
                <label for="attendanceDate"></label>
                <input type="date" id="attendanceDate" value="">
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 ابحث عن الطالب..." oninput="filterStudents()">
            </div>
            
            <button class="btn btn-primary" onclick="loadStudents()">
                🔄 إعادة تحميل
            </button>
            
            <button class="btn btn-success" onclick="saveAttendance()">
                💾 حفظ الحضور
            </button>
        </div>

        <div id="successMessage" class="alert success">✅ تم حفظ بيانات الحضور بنجاح!</div>
        <div id="errorMessage" class="alert error">❌ حدث خطأ أثناء حفظ البيانات. يرجى المحاولة مرة أخرى.</div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>إجمالي الطلاب</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>الحاضرون</h3>
                <div class="number" id="presentCount">0</div>
            </div>
            <div class="stat-card">
                <h3>الغائبون</h3>
                <div class="number" id="absentCount">0</div>
            </div>
            <div class="stat-card">
                <h3>لم يتم التسجيل</h3>
                <div class="number" id="notMarkedCount">0</div>
            </div>
        </div>
        
        <div id="loading" style="text-align:center; padding: 30px; color: #666; font-weight: bold; display: none;">
            ⏳ جاري تحميل بيانات الطلاب...
        </div>
        
        <div id="studentsContainer" class="students-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; padding: 20px;"></div>
        

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <!-- xlsx library for Excel export functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
      // Firebase Configuration
      const firebaseConfig = {
          apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
          authDomain: "edad-5odam.firebaseapp.com",
          databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "edad-5odam",
          storageBucket: "edad-5odam.appspot.com",
          messagingSenderId: "679576633778",
          appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let students = [];
      let attendanceData = {};

      // Set today's date as default
      document.getElementById('attendanceDate').valueAsDate = new Date();

      // Load students from Firebase
      async function loadStudents() {
          try {
              document.getElementById('loading').style.display = 'block';
              document.getElementById('studentsContainer').innerHTML = '';
              
              const studentsRef = database.ref('users');
              const snapshot = await studentsRef.once('value');
              
              students = [];
              if (snapshot.exists()) {
                  const data = snapshot.val();
                  
                  Object.keys(data).forEach(key => {
                      const student = data[key];
                      if (!student.role || student.role === 'student' || student.role.toLowerCase() === 'student') {
                          const studentData = {
                              id: key,
                              name: student.username || student.name || student.fullName || 'بدون اسم',
                              email: student.email || '',
                              team: student.team || student.group || 'غير محدد',
                              phone: student.phone || ''
                          };
                          students.push(studentData);
                      }
                  });
              }
              
              displayStudents();
              document.getElementById('loading').style.display = 'none';
              
          } catch (error) {
              console.error('Error loading students:', error);
              document.getElementById('loading').innerHTML = '❌ خطأ في تحميل البيانات';
          }
      }

      // Display students in the UI
      function displayStudents() {
          const container = document.getElementById('studentsContainer');
          container.innerHTML = '';

          if (students.length === 0) {
              container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">لا توجد بيانات طلاب</div>';
              return;
          }

          students.forEach(student => {
              const studentCard = document.createElement('div');
              studentCard.className = 'student-card';
              studentCard.innerHTML = `
                  <div class="student-info">
                      <div class="student-avatar">
                          ${student.name.charAt(0).toUpperCase()}
                      </div>
                      <div class="student-details">
                          <h4>${student.name}</h4>
                          <p>📧 ${student.email} | 👥 ${student.team}</p>
                      </div>
                  </div>
                  <div class="attendance-buttons">
                      <button class="attendance-btn btn-present" onclick="markAttendance('${student.id}', 'present')">
                          حاضر
                      </button>
                      <button class="attendance-btn btn-absent" onclick="markAttendance('${student.id}', 'absent')">
                          غائب
                      </button>
                  </div>
              `;
              container.appendChild(studentCard);
          });

          updateStats();
      }

      // Mark attendance for a student
      function markAttendance(studentId, status) {
          attendanceData[studentId] = status;
          
          const studentCard = event.target.closest('.student-card');
          const buttons = studentCard.querySelectorAll('.attendance-btn');
          
          buttons.forEach(btn => {
              btn.classList.remove('active');
          });
          
          event.target.classList.add('active');
          
          event.target.style.transform = 'scale(0.95)';
          setTimeout(() => {
              event.target.style.transform = '';
          }, 150);
          
          updateStats();
      }

      // Update statistics
      function updateStats() {
          const totalStudents = students.length;
          const presentCount = Object.values(attendanceData).filter(status => status === 'present').length;
          const absentCount = Object.values(attendanceData).filter(status => status === 'absent').length;
          const notMarkedCount = totalStudents - presentCount - absentCount;

          document.getElementById('totalStudents').textContent = totalStudents;
          document.getElementById('presentCount').textContent = presentCount;
          document.getElementById('absentCount').textContent = absentCount;
          document.getElementById('notMarkedCount').textContent = notMarkedCount;
      }

      // Filter students based on search
      function filterStudents() {
          const searchText = document.getElementById('searchInput').value.toLowerCase();
          const studentCards = document.querySelectorAll('.student-card');
          
          studentCards.forEach(card => {
              const studentName = card.querySelector('h4').textContent.toLowerCase();
              const studentDetails = card.querySelector('p').textContent.toLowerCase();
              
              if (studentName.includes(searchText) || studentDetails.includes(searchText)) {
                  card.style.display = 'flex';
              } else {
                  card.style.display = 'none';
              }
          });
      }

      // Save attendance to Firebase
      async function saveAttendance() {
          try {
              const selectedDate = document.getElementById('attendanceDate').value;
              if (!selectedDate) {
                  alert('يرجى اختيار التاريخ');
                  return;
              }

              if (Object.keys(attendanceData).length === 0) {
                  alert('يرجى تسجيل حضور الطلاب أولاً');
                  return;
              }

              const attendanceRef = database.ref('attendance/' + selectedDate);
              const promises = [];

              Object.keys(attendanceData).forEach(studentId => {
                  const student = students.find(s => s.id === studentId);
                  const attendanceRecord = {
                      studentId: studentId,
                      studentName: student.name,
                      team: student.team,
                      status: attendanceData[studentId],
                      timestamp: firebase.database.ServerValue.TIMESTAMP
                  };
                  
                  promises.push(attendanceRef.child(studentId).set(attendanceRecord));
              });

              await Promise.all(promises);
              
              showMessage("success");

              attendanceData = {};
              
              document.querySelectorAll('.attendance-btn.active').forEach(btn => {
                  btn.classList.remove('active');
              });
              
              updateStats();

          } catch (error) {
              console.error('Error saving attendance:', error);
              showMessage("error");
          }
      }

      // Print report function
      function printReport() {
          if (students.length === 0) {
              alert('لا توجد بيانات للطباعة');
              return;
          }

          // Add print date info
          const selectedDate = document.getElementById('attendanceDate').value;
          const today = new Date();
          const dateStr = selectedDate || today.toLocaleDateString('ar-EG');
          
          // Create a temporary div for print date
          const printDateDiv = document.createElement('div');
          printDateDiv.className = 'print-date';
          printDateDiv.innerHTML = `<strong>تاريخ التقرير: ${dateStr}</strong><br><strong>تاريخ الطباعة: ${today.toLocaleDateString('ar-EG')} - ${today.toLocaleTimeString('ar-EG')}</strong>`;
          
          // Insert after header
          const header = document.querySelector('.header');
          header.parentNode.insertBefore(printDateDiv, header.nextSibling);
          
          // Hide elements that shouldn't be printed
          const hideElements = document.querySelectorAll('.search-box input');
          hideElements.forEach(el => {
              el.style.display = 'none';
          });

          // Trigger print
          window.print();
          
          // Clean up after print
          setTimeout(() => {
              printDateDiv.remove();
              hideElements.forEach(el => {
                  el.style.display = '';
              });
          }, 1000);
      }

      // Export to Excel function
      function exportToExcel() {
          if (students.length === 0) {
              alert('لا توجد بيانات للتصدير');
              return;
          }

          const selectedDate = document.getElementById('attendanceDate').value;
          const today = new Date();
          const dateStr = selectedDate || today.toISOString().split('T')[0];
          
          // Prepare data for Excel
          const excelData = students.map((student, index) => {
              const status = attendanceData[student.id] || 'لم يتم التسجيل';
              const statusText = status === 'present' ? 'حاضر' : 
                               status === 'absent' ? 'غائب' : 'لم يتم التسجيل';
              
              return {
                  'الرقم': index + 1,
                  'الاسم': student.name,
                  'الفريق': student.team,
                  'الحالة': statusText,
                  'البريد الإلكتروني': student.email,
                  'التاريخ': dateStr
              };
          });

          // Create summary data
          const totalStudents = students.length;
          const presentCount = Object.values(attendanceData).filter(status => status === 'present').length;
          const absentCount = Object.values(attendanceData).filter(status => status === 'absent').length;
          const notMarkedCount = totalStudents - presentCount - absentCount;

          const summaryData = [
              { 'الإحصائية': 'إجمالي الطلاب', 'العدد': totalStudents },
              { 'الإحصائية': 'الحاضرون', 'العدد': presentCount },
              { 'الإحصائية': 'الغائبون', 'العدد': absentCount },
              { 'الإحصائية': 'لم يتم التسجيل', 'العدد': notMarkedCount },
              { 'الإحصائية': 'التاريخ', 'العدد': dateStr }
          ];

          // Create workbook
          const wb = XLSX.utils.book_new();
          
          // Create attendance sheet
          const ws1 = XLSX.utils.json_to_sheet(excelData);
          XLSX.utils.book_append_sheet(wb, ws1, 'تقرير الحضور');
          
          // Create summary sheet
          const ws2 = XLSX.utils.json_to_sheet(summaryData);
          XLSX.utils.book_append_sheet(wb, ws2, 'الإحصائيات');

          // Save the Excel file
          XLSX.writeFile(wb, `attendance_report_${dateStr}.xlsx`);
      }

      // Mobile menu toggle function
      function toggleMobileMenu() {
          const navMenu = document.getElementById('navMenu');
          navMenu.classList.toggle('active');
      }

      // Logout function
      function logout() {
          if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
              localStorage.removeItem('userToken');
              sessionStorage.clear();
              window.location.href = 'index.html';
          }
      }

      // Load students on page load
      window.onload = function() {
          loadStudents();
      };

      // Close mobile menu when clicking on a link
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
          link.addEventListener('click', function() {
              const navMenu = document.getElementById('navMenu');
              navMenu.classList.remove('active');
          });
      });
      
      function showMessage(type) {
          const success = document.getElementById("successMessage");
          const error = document.getElementById("errorMessage");

          success.style.display = "none";
          error.style.display = "none";

          if (type === "success") {
              success.style.display = "block";
              setTimeout(() => success.style.display = "none", 3000);
          } else if (type === "error") {
              error.style.display = "block";
              setTimeout(() => error.style.display = "none", 3000);
          }
      }

      document.querySelector('.menu-toggle').addEventListener('click', function () {
  document.querySelector('.nav-right').classList.toggle('show');
});

  </script>
</div>
</body>
</html>
