<!DOCTYPE html>
<html lang="ar"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styleAttendanceData.css">
   <link rel="icon" type="image/png" href="logoCircle1.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± </title>
</head>
<body>
    <style>
      .controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.controls > * {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px;
  flex: 1 1 200px;
  box-sizing: border-box;
}

.date-picker label,
.search-box label {
  white-space: nowrap;
  font-size: 14px;
  line-height: 1; 
}

.date-picker input,
.search-box input {
  flex: 1;
  padding: 5px 10px;
  font-size: 14px;
  line-height: 1.5;
}

.btn {
  padding: 8px 12px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
  justify-content: center;
  align-items: center;
  display: flex;
}

.btn-primary {
  background-color: var(--primary, #233B6E);
  color: white;
  border: none;
  border-radius: 4px;
}

.btn-success {
  background-color: var(--success, #4CAF50);
  color: white;
  border: none;
  border-radius: 4px;
}
.alert {
  display: none;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
  font-weight: bold;
  transition: all 0.3s ease-in-out;
}

.success {
  background-color: #d4edda;
  color: #155724;
}

.error {
  background-color: #f8d7da;
  color: #721c24;
}
.filter-team {
  display: flex;
  align-items: center;
  gap: 5px;
  flex: 1 1 200px;
  margin-top: 20px; 
}

.filter-team label {
  font-size: 14px;
}
.filter-team select {
  flex: 1;
  padding: 5px;
  font-size: 14px;
}

#scrollToTop {
  position: fixed;
  bottom: 30px;
  left: 30px;
  width: 50px;
  height: 50px;
  background: linear-gradient(145deg, #233B6E, #1b2e5c);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: none;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  font-size: 28px;
}

#scrollToTop:hover {
  transform: translateY(-5px) scale(1.1);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35);
}

#scrollToTop svg {
  width: 24px;
  height: 24px;
  fill: #fff;
}

      .cross-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}
.glowing-cross {
    font-size: 50px;
    color: white;
    opacity: 0.6;
    filter: drop-shadow(0 0 8px rgba(173, 216, 230, 0.4));
    transition: all 0.3s ease;
    position: absolute;
    top: 40px;
    left: 40px;
  }

 
.cross {
  position: absolute;
  width: 30px;
  height: 30px;
  animation: float 12s linear infinite;
  opacity: 0.7;
  filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.6));
}

.cross svg {
  width: 100%;
  height: 100%;
  fill: rgba(255, 255, 255, 0.265);
}

@keyframes float {
  0% {
    transform: translateY(100vh) scale(1);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    transform: translateY(-20vh) scale(1.3);
    opacity: 0;
  }
}


          </style>

<nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
    </div>
    <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="teacherDashboard.html" class="nav-link">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a href="AttendanceData.html" class="nav-link">Ø£Ø®Ø° Ø§Ù„Ø­Ø¶ÙˆØ±</a>
      <a href="profilepage.html" class="nav-link">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>
      <div class="container">
                <div class="cross-background"></div>

        <div class="header">
 <div class="animate__animated animate__fadeInUp"><h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>  </div>
	</div>

        <div class="controls">
            <div class="date-picker">
                <label for="attendanceDate"></label>
                <input type="date" id="attendanceDate" value="">
            </div>
            
            <div class="date-picker">
                <select id="periodSelect" >
                    <option value="period1">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
                    <option value="period2">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
                </select>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..." oninput="filterStudents()">
            </div>
            
            <button class="btn btn-primary" onclick="loadStudents()">
                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
            </button>
            
            <button class="btn btn-success" onclick="saveAttendance()">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±
            </button>
        </div>

        <div id="successMessage" class="alert success">âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!</div>
        <div id="errorMessage" class="alert error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†</h3>
                <div class="number" id="presentCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†</h3>
                <div class="number" id="absentCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                <div class="number" id="notMarkedCount">0</div>
            </div>
        </div>
          <div class="filter-team">
                <select id="teamFilter" onchange="filterStudents()">
                  <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                </select>
              </div>
              
        <div id="loading" style="text-align:center; padding: 30px; color: #666; font-weight: bold; display: none;">
            â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨...
        </div>
        
        <div id="studentsContainer" class="students-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; padding: 20px;"></div>
    </div>
      <button id="scrollToTop" title="Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰">â†‘</button>

  <footer>
    Â© ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø³ÙŠØ¯Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ - Ø¹Ø²Ø¨Ø© Ø§Ù„Ù†Ø®Ù„ | ØªØ·Ø¨ÙŠÙ‚ Ø®Ø¯Ù…ØªÙŠ 2025
  </footer>


  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="sessionUtils.js"></script>

  <script>
    const firebaseConfig = {
    apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
    authDomain: "edad-5odam.firebaseapp.com",
    databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "edad-5odam",
    storageBucket: "edad-5odam.appspot.com",
    messagingSenderId: "679576633778",
    appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
  };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let students = [];
      let attendanceData = {};

      // Check if user is authenticated and has servant role
      async function checkAuthentication() {
        const currentEmail = await requireAuthentication("login.html");
        console.log("Current email from session:", currentEmail);
        
        if (!currentEmail) {
          alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
          window.location.href = "login.html";
          return false;
        }

        const emailKey = currentEmail.replace(/[.#$\[\]]/g, '_');
        
        try {
          const userSnapshot = await database.ref(`users/${emailKey}`).once('value');
          const userData = userSnapshot.val();
          
          if (!userData || Object.keys(userData).length === 0) {
            console.log("No user data found, redirecting to login");
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
            window.location.href = "login.html";
            return false;
          }

          // Check if user is a servant/teacher
          if (!checkIfServant(userData)) {
            console.log("User is not a servant, access denied");
            alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø®Ø¯Ø§Ù… ÙÙ‚Ø·");
            window.location.href = "login.html";
            return false;
          }

          console.log("User authenticated successfully as servant");
          return true;
          
        } catch (error) {
          console.error("Error checking authentication:", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
          window.location.href = "login.html";
          return false;
        }
      }

      function checkIfServant(userData) {
        if (!userData || !userData.role) {
          console.log("No role found in user data");
          return false;
        }
        
        const userRole = userData.role.toLowerCase();
        const allowedRoles = ['teacher', 'servant', 'admin', 'Ø®Ø§Ø¯Ù…', 'Ù…Ø¹Ù„Ù…', 'Ù…Ø¯ÙŠØ±'];
        
        console.log("User role:", userRole);
        console.log("Checking against allowed roles:", allowedRoles);
        
        const isServant = allowedRoles.includes(userRole);
        console.log("Is servant:", isServant);
        
        return isServant;
      }

      document.getElementById('attendanceDate').valueAsDate = new Date();

async function loadStudents() {
    // Check authentication before loading data
    const isAuthenticated = await checkAuthentication();
    if (!isAuthenticated) {
      return;
    }

    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('studentsContainer').innerHTML = '';
        
        const studentsRef = database.ref('users');
        const snapshot = await studentsRef.once('value');
        
        students = [];

        if (snapshot.exists()) {
            const data = snapshot.val();

            Object.keys(data).forEach(key => {
                const student = data[key];
                if (!student.role || student.role === 'student' || student.role.toLowerCase() === 'student') {
                    const studentData = {
                        id: key,
                        name: student.username || student.name || student.fullName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                        email: student.email || '',
                        team: student.team || student.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        phone: student.phone || ''
                    };
                    students.push(studentData);
                }
            });

            const teamsSet = new Set();
            students.forEach(student => {
                if (student.team) {
                    teamsSet.add(student.team);
                }
            });

            const teamFilter = document.getElementById('teamFilter');
            teamFilter.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>`;
            teamsSet.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });
        }

        displayStudents();
        document.getElementById('loading').style.display = 'none';
        
    } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('loading').innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }
}

      function displayStudents() {
          const container = document.getElementById('studentsContainer');
          container.innerHTML = '';

          if (students.length === 0) {
              container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨</div>';
              return;
          }

          // Sort students alphabetically by Arabic name
          const sortedStudents = [...students].sort((a, b) => {
              return a.name.localeCompare(b.name, 'ar', { 
                  numeric: true, 
                  sensitivity: 'base' 
              });
          });

          sortedStudents.forEach(student => {
              const studentCard = document.createElement('div');
              studentCard.className = 'student-card';
              studentCard.innerHTML = `
                  <div class="student-info">
                      <div class="student-avatar">
                          ${student.name.charAt(0).toUpperCase()}
                      </div>
                      <div class="student-details">
                          <h4>${student.name}</h4>
                          <p>ğŸ“§ ${student.email} | ğŸ‘¥ ${student.team}</p>
                      </div>
                  </div>
                  <div class="attendance-buttons">
                      <button class="attendance-btn btn-present" onclick="markAttendance(event, '${student.id}', 'present')">
                          Ø­Ø§Ø¶Ø±
                      </button>
                      <button class="attendance-btn btn-absent" onclick="markAttendance(event, '${student.id}', 'absent')">
                          ØºØ§Ø¦Ø¨
                      </button>
                  </div>
              `;
              container.appendChild(studentCard);
          });

          updateStats();
      }

      function markAttendance(event, studentId, status) {
          attendanceData[studentId] = status;
          
          const studentCard = event.target.closest('.student-card');
          const buttons = studentCard.querySelectorAll('.attendance-btn');
          
          buttons.forEach(btn => {
              btn.classList.remove('active');
          });
          
          event.target.classList.add('active');
          
          event.target.style.transform = 'scale(0.95)';
          setTimeout(() => {
              event.target.style.transform = '';
          }, 150);
          
          updateStats();
      }

      function updateStats() {
          const totalStudents = students.length;
          const presentCount = Object.values(attendanceData).filter(status => status === 'present').length;
          const absentCount = Object.values(attendanceData).filter(status => status === 'absent').length;
          const notMarkedCount = totalStudents - presentCount - absentCount;

          document.getElementById('totalStudents').textContent = totalStudents;
          document.getElementById('presentCount').textContent = presentCount;
          document.getElementById('absentCount').textContent = absentCount;
          document.getElementById('notMarkedCount').textContent = notMarkedCount;

          // Update save button appearance based on completion
          const saveButton = document.querySelector('.btn-success');
          if (notMarkedCount === 0 && totalStudents > 0) {
              // All students marked - enable and highlight button
              saveButton.style.background = '#28a745';
              saveButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…ÙƒØªÙ…Ù„ âœ…)';
              saveButton.disabled = false;
          } else if (presentCount + absentCount > 0) {
              // Partially marked - warning style
              saveButton.style.background = '#fd7e14';
              saveButton.innerHTML = `ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± (${notMarkedCount} ØºÙŠØ± Ù…Ø³Ø¬Ù„ âš ï¸)`;
              saveButton.disabled = false;
          } else {
              // Nothing marked - default style
              saveButton.style.background = '#6c757d';
              saveButton.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±';
              saveButton.disabled = true;
          }
      }

      function filterStudents() {
  const searchText = document.getElementById('searchInput').value.toLowerCase();
  const selectedTeam = document.getElementById('teamFilter').value;
  const studentCards = document.querySelectorAll('.student-card');

  studentCards.forEach(card => {
    const studentName = card.querySelector('h4').textContent.toLowerCase();
    const studentDetails = card.querySelector('p').textContent.toLowerCase();

    const matchesSearch = studentName.includes(searchText) || studentDetails.includes(searchText);
    const matchesTeam = selectedTeam === "" || studentDetails.includes(selectedTeam.toLowerCase());

    if (matchesSearch && matchesTeam) {
      card.style.display = 'flex';
    } else {
      card.style.display = 'none';
    }
  });
}


      async function saveAttendance() {
          // Check authentication before saving
          const isAuthenticated = await checkAuthentication();
          if (!isAuthenticated) {
            return;
          }

          try {
              const selectedDate = document.getElementById('attendanceDate').value;
              const selectedPeriod = document.getElementById('periodSelect').value;
              
              if (!selectedDate) {
                  alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®');
                  return;
              }

              if (Object.keys(attendanceData).length === 0) {
                  alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
                  return;
              }

              // Check if all students have attendance marked
              const totalStudents = students.length;
              const markedStudents = Object.keys(attendanceData).length;
              
              if (markedStudents < totalStudents) {
                  const unmarkedCount = totalStudents - markedStudents;
                  const periodText = selectedPeriod === 'period1' ? 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©';
                  const confirmMessage = `ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ${unmarkedCount} Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ ${periodText}.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙ‚Ø·ØŸ\n\nØ£Ù… ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ`;
                  
                  if (!confirm(confirmMessage)) {
                      // User chose to go back and mark all students
                      return;
                  }
              }

              const attendanceRef = database.ref('attendance/' + selectedDate + '/' + selectedPeriod);
              const promises = [];

              Object.keys(attendanceData).forEach(studentId => {
                  const student = students.find(s => s.id === studentId);
                  const periodText = selectedPeriod === 'period1' ? 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©';
                  const attendanceRecord = {
                      studentId: studentId,
                      studentName: student.name,
                      team: student.team,
                      status: attendanceData[studentId],
                      period: periodText,
                      timestamp: firebase.database.ServerValue.TIMESTAMP
                  };
                  
                  promises.push(attendanceRef.child(studentId).set(attendanceRecord));
              });

              await Promise.all(promises);
              
              const periodText = selectedPeriod === 'period1' ? 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©';
              const successMsg = document.getElementById('successMessage');
              successMsg.textContent = `âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù€ ${periodText} Ø¨Ù†Ø¬Ø§Ø­!`;
              successMsg.style.display = 'block';
              setTimeout(() => {
                  successMsg.style.display = 'none';
              }, 3000);

              attendanceData = {};
              
              document.querySelectorAll('.attendance-btn.active').forEach(btn => {
                  btn.classList.remove('active');
              });
              
              updateStats();

          } catch (error) {
              console.error('Error saving attendance:', error);
              const errorMsg = document.getElementById('errorMessage');
              errorMsg.style.display = 'block';
              setTimeout(() => {
                  errorMsg.style.display = 'none';
              }, 3000);
          }
      }

      function printReport() {
          if (students.length === 0) {
              alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
              return;
          }

          const selectedDate = document.getElementById('attendanceDate').value;
          const today = new Date();
          const dateStr = selectedDate || today.toLocaleDateString('ar-EG');
          
          const printDateDiv = document.createElement('div');
          printDateDiv.className = 'print-date';
          printDateDiv.innerHTML = `<strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${dateStr}</strong><br><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${today.toLocaleDateString('ar-EG')} - ${today.toLocaleTimeString('ar-EG')}</strong>`;
          
          const header = document.querySelector('.header');
          header.parentNode.insertBefore(printDateDiv, header.nextSibling);
          
          const hideElements = document.querySelectorAll('.search-box input');
          hideElements.forEach(el => {
              el.style.display = 'none';
          });

          window.print();
          
          setTimeout(() => {
              printDateDiv.remove();
              hideElements.forEach(el => {
                  el.style.display = '';
              });
          }, 1000);
      }

      function exportToExcel() {
          if (students.length === 0) {
              alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
              return;
          }

          const selectedDate = document.getElementById('attendanceDate').value;
          const today = new Date();
          const dateStr = selectedDate || today.toISOString().split('T')[0];
          
          const excelData = students.map((student, index) => {
              const status = attendanceData[student.id] || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
              const statusText = status === 'present' ? 'Ø­Ø§Ø¶Ø±' : 
                               status === 'absent' ? 'ØºØ§Ø¦Ø¨' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
              
              return {
                  'Ø§Ù„Ø±Ù‚Ù…': index + 1,
                  'Ø§Ù„Ø§Ø³Ù…': student.name,
                  'Ø§Ù„ÙØ±ÙŠÙ‚': student.team,
                  'Ø§Ù„Ø­Ø§Ù„Ø©': statusText,
                  'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': student.email,
                  'Ø§Ù„ØªØ§Ø±ÙŠØ®': dateStr
              };
          });

          const totalStudents = students.length;
          const presentCount = Object.values(attendanceData).filter(status => status === 'present').length;
          const absentCount = Object.values(attendanceData).filter(status => status === 'absent').length;
          const notMarkedCount = totalStudents - presentCount - absentCount;

          const summaryData = [
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', 'Ø§Ù„Ø¹Ø¯Ø¯': totalStudents },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†', 'Ø§Ù„Ø¹Ø¯Ø¯': presentCount },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†', 'Ø§Ù„Ø¹Ø¯Ø¯': absentCount },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'Ø§Ù„Ø¹Ø¯Ø¯': notMarkedCount },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¹Ø¯Ø¯': dateStr }
          ];

          // Create workbook
          const wb = XLSX.utils.book_new();
          
          const ws1 = XLSX.utils.json_to_sheet(excelData);
          XLSX.utils.book_append_sheet(wb, ws1, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±');
          
          const ws2 = XLSX.utils.json_to_sheet(summaryData);
          XLSX.utils.book_append_sheet(wb, ws2, 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');

          XLSX.writeFile(wb, `attendance_report_${dateStr}.xlsx`);
      }

      function toggleMobileMenu() {
          const navMenu = document.getElementById('navMenu');
          navMenu.classList.toggle('active');
      }

      function logout() {
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
              localStorage.removeItem('userToken');
               clearSession();
              window.location.href = 'index.html';
          }
      }

      window.onload = function() {
          loadStudents();
      };

      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
          link.addEventListener('click', function() {
              const navMenu = document.getElementById('navMenu');
              navMenu.classList.remove('active');
          });
      });
      function showMessage(type) {
  const success = document.getElementById("successMessage");
  const error = document.getElementById("errorMessage");

  success.style.display = "none";
  error.style.display = "none";

  if (type === "success") {
    success.style.display = "block";
    setTimeout(() => success.style.display = "none", 3000);
  } else if (type === "error") {
    error.style.display = "block";
    setTimeout(() => error.style.display = "none", 3000);
  }
}

document.querySelector('.menu-toggle').addEventListener('click', function () {
  document.querySelector('.nav-right').classList.toggle('show');
});
window.addEventListener('scroll', function () {
      const footer = document.querySelector('footer');
      const scrollThreshold = -300;
      if (window.scrollY > scrollThreshold) {
        footer.classList.add('visible');
      } else {
        footer.classList.remove('visible');
      }
    });
    window.addEventListener('scroll', function () {
  const scrollBtn = document.getElementById("scrollToTop");
  if (window.scrollY > 300) {
    scrollBtn.style.display = "block";
  } else {
    scrollBtn.style.display = "none";
  }
});

document.getElementById("scrollToTop").addEventListener("click", function () {
  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });
});
const container = document.querySelector('.cross-background');

  const svgCross = `
  <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!-- License: CC0. Made by SVG Repo: https://www.svgrepo.com/svg/90761/cross -->
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 60 60" style="enable-background:new 0 0 60 60;" xml:space="preserve">
<path d="M52.247,19.665c-0.396,0-0.785,0.049-1.162,0.145c-0.403-2.214-2.347-3.897-4.675-3.897c-2.396,0-4.382,1.781-4.707,4.087
	H35v-4.811c2.077-0.517,3.594-2.381,3.594-4.599c0-2.188-1.486-4.036-3.503-4.586c0.11-0.404,0.167-0.824,0.167-1.251
	C35.258,2.132,33.126,0,30.506,0c-2.621,0-4.753,2.132-4.753,4.753c0,0.395,0.049,0.785,0.145,1.162C23.684,6.318,22,8.262,22,10.59
	c0,2.364,1.735,4.331,4,4.693V20h-7.812c-0.516-2.077-2.38-3.594-4.599-3.594c-2.188,0-4.035,1.486-4.585,3.503
	c-0.405-0.11-0.825-0.167-1.252-0.167C5.132,19.742,3,21.874,3,24.495s2.132,4.753,4.753,4.753c0.396,0,0.785-0.049,1.162-0.145
	C9.318,31.316,11.262,33,13.59,33c2.365,0,4.332-1.736,4.693-4H26v15.84c-2.026,0.551-3.506,2.405-3.506,4.569
	c0,2.188,1.486,4.036,3.502,4.586c-0.11,0.405-0.167,0.825-0.167,1.252c0,2.621,2.132,4.752,4.753,4.752s4.753-2.132,4.753-4.752
	c0-0.395-0.049-0.785-0.146-1.162c2.215-0.404,3.898-2.347,3.898-4.676c0-2.395-1.781-4.382-4.088-4.706V29h6.84
	c0.552,2.027,2.406,3.506,4.57,3.506c2.188,0,4.035-1.486,4.585-3.503c0.405,0.11,0.825,0.167,1.252,0.167
	c2.621,0,4.753-2.132,4.753-4.752S54.868,19.665,52.247,19.665z"/>
</svg>

  `;

  for (let i = 0; i < 25; i++) {
    const cross = document.createElement('div');
    cross.className = 'cross';
    cross.innerHTML = svgCross;
    cross.style.left = Math.random() * 100 + 'vw';
    cross.style.top = Math.random() * 100 + 'vh';
    cross.style.animationDuration = (12 + Math.random() * 11) + 's';
    container.appendChild(cross);
  }
  </script>
</div>
</body>
</html>
