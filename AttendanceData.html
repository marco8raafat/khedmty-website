<!DOCTYPE html>
<html lang="ar"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styleAttendance.css">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± </title>
</head>
<body>
    <style>
      .controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.controls > * {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px;
  flex: 1 1 200px;
  box-sizing: border-box;
}

.date-picker label,
.search-box label {
  white-space: nowrap;
  font-size: 14px;
  line-height: 1; 
}

.date-picker input,
.search-box input {
  flex: 1;
  padding: 5px 10px;
  font-size: 14px;
  line-height: 1.5;
}

.btn {
  padding: 8px 12px;
  font-size: 14px;
  white-space: nowrap;
  cursor: pointer;
  justify-content: center;
  align-items: center;
  display: flex;
}

.btn-primary {
  background-color: var(--primary, #233B6E);
  color: white;
  border: none;
  border-radius: 4px;
}

.btn-success {
  background-color: var(--success, #4CAF50);
  color: white;
  border: none;
  border-radius: 4px;
}
.alert {
  display: none;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
  font-weight: bold;
  transition: all 0.3s ease-in-out;
}

.success {
  background-color: #d4edda;
  color: #155724;
}

.error {
  background-color: #f8d7da;
  color: #721c24;
}

          </style>

  <nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
    </div>
    <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="teacherDashboard.html" class="nav-link">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
      <a href="AttendanceData.html" class="nav-link">Ø£Ø®Ø° Ø§Ù„Ø­Ø¶ÙˆØ±</a>
      <a href="profilepage.html" class="nav-link">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </nav>
      <div class="container">
        <div class="header">
          <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        </div>

        <div class="controls">
            <div class="date-picker">
                <label for="attendanceDate"></label>
                <input type="date" id="attendanceDate" value="">
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..." oninput="filterStudents()">
            </div>
            
            <button class="btn btn-primary" onclick="loadStudents()">
                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
            </button>
            
            <button class="btn btn-success" onclick="saveAttendance()">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±
            </button>
        </div>

        <div id="successMessage" class="alert success">âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!</div>
        <div id="errorMessage" class="alert error">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†</h3>
                <div class="number" id="presentCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†</h3>
                <div class="number" id="absentCount">0</div>
            </div>
            <div class="stat-card">
                <h3>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                <div class="number" id="notMarkedCount">0</div>
            </div>
        </div>
        
        <div id="loading" style="text-align:center; padding: 30px; color: #666; font-weight: bold; display: none;">
            â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨...
        </div>
        
        <div id="studentsContainer" class="students-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; padding: 20px;"></div>
        

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <!-- xlsx library for Excel export functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
      // Firebase Configuration
      const firebaseConfig = {
          apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
          authDomain: "edad-5odam.firebaseapp.com",
          databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "edad-5odam",
          storageBucket: "edad-5odam.appspot.com",
          messagingSenderId: "679576633778",
          appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let students = [];
      let attendanceData = {};

      // Set today's date as default
      document.getElementById('attendanceDate').valueAsDate = new Date();

      // Load students from Firebase
      async function loadStudents() {
          try {
              document.getElementById('loading').style.display = 'block';
              document.getElementById('studentsContainer').innerHTML = '';
              
              const studentsRef = database.ref('users');
              const snapshot = await studentsRef.once('value');
              
              students = [];
              if (snapshot.exists()) {
                  const data = snapshot.val();
                  
                  Object.keys(data).forEach(key => {
                      const student = data[key];
                      if (!student.role || student.role === 'student' || student.role.toLowerCase() === 'student') {
                          const studentData = {
                              id: key,
                              name: student.username || student.name || student.fullName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
                              email: student.email || '',
                              team: student.team || student.group || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                              phone: student.phone || ''
                          };
                          students.push(studentData);
                      }
                  });
              }
              
              displayStudents();
              document.getElementById('loading').style.display = 'none';
              
          } catch (error) {
              console.error('Error loading students:', error);
              document.getElementById('loading').innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
          }
      }

      // Display students in the UI
      function displayStudents() {
          const container = document.getElementById('studentsContainer');
          container.innerHTML = '';

          if (students.length === 0) {
              container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨</div>';
              return;
          }

          students.forEach(student => {
              const studentCard = document.createElement('div');
              studentCard.className = 'student-card';
              studentCard.innerHTML = `
                  <div class="student-info">
                      <div class="student-avatar">
                          ${student.name.charAt(0).toUpperCase()}
                      </div>
                      <div class="student-details">
                          <h4>${student.name}</h4>
                          <p>ğŸ“§ ${student.email} | ğŸ‘¥ ${student.team}</p>
                      </div>
                  </div>
                  <div class="attendance-buttons">
                      <button class="attendance-btn btn-present" onclick="markAttendance('${student.id}', 'present')">
                          Ø­Ø§Ø¶Ø±
                      </button>
                      <button class="attendance-btn btn-absent" onclick="markAttendance('${student.id}', 'absent')">
                          ØºØ§Ø¦Ø¨
                      </button>
                  </div>
              `;
              container.appendChild(studentCard);
          });

          updateStats();
      }

      // Mark attendance for a student
      function markAttendance(studentId, status) {
          attendanceData[studentId] = status;
          
          const studentCard = event.target.closest('.student-card');
          const buttons = studentCard.querySelectorAll('.attendance-btn');
          
          buttons.forEach(btn => {
              btn.classList.remove('active');
          });
          
          event.target.classList.add('active');
          
          event.target.style.transform = 'scale(0.95)';
          setTimeout(() => {
              event.target.style.transform = '';
          }, 150);
          
          updateStats();
      }

      // Update statistics
      function updateStats() {
          const totalStudents = students.length;
          const presentCount = Object.values(attendanceData).filter(status => status === 'present').length;
          const absentCount = Object.values(attendanceData).filter(status => status === 'absent').length;
          const notMarkedCount = totalStudents - presentCount - absentCount;

          document.getElementById('totalStudents').textContent = totalStudents;
          document.getElementById('presentCount').textContent = presentCount;
          document.getElementById('absentCount').textContent = absentCount;
          document.getElementById('notMarkedCount').textContent = notMarkedCount;
      }

      // Filter students based on search
      function filterStudents() {
          const searchText = document.getElementById('searchInput').value.toLowerCase();
          const studentCards = document.querySelectorAll('.student-card');
          
          studentCards.forEach(card => {
              const studentName = card.querySelector('h4').textContent.toLowerCase();
              const studentDetails = card.querySelector('p').textContent.toLowerCase();
              
              if (studentName.includes(searchText) || studentDetails.includes(searchText)) {
                  card.style.display = 'flex';
              } else {
                  card.style.display = 'none';
              }
          });
      }

      // Save attendance to Firebase
      async function saveAttendance() {
          try {
              const selectedDate = document.getElementById('attendanceDate').value;
              if (!selectedDate) {
                  alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®');
                  return;
              }

              if (Object.keys(attendanceData).length === 0) {
                  alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
                  return;
              }

              const attendanceRef = database.ref('attendance/' + selectedDate);
              const promises = [];

              Object.keys(attendanceData).forEach(studentId => {
                  const student = students.find(s => s.id === studentId);
                  const attendanceRecord = {
                      studentId: studentId,
                      studentName: student.name,
                      team: student.team,
                      status: attendanceData[studentId],
                      timestamp: firebase.database.ServerValue.TIMESTAMP
                  };
                  
                  promises.push(attendanceRef.child(studentId).set(attendanceRecord));
              });

              await Promise.all(promises);
              
              showMessage("success");

              attendanceData = {};
              
              document.querySelectorAll('.attendance-btn.active').forEach(btn => {
                  btn.classList.remove('active');
              });
              
              updateStats();

          } catch (error) {
              console.error('Error saving attendance:', error);
              showMessage("error");
          }
      }

      // Print report function
      function printReport() {
          if (students.length === 0) {
              alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
              return;
          }

          // Add print date info
          const selectedDate = document.getElementById('attendanceDate').value;
          const today = new Date();
          const dateStr = selectedDate || today.toLocaleDateString('ar-EG');
          
          // Create a temporary div for print date
          const printDateDiv = document.createElement('div');
          printDateDiv.className = 'print-date';
          printDateDiv.innerHTML = `<strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${dateStr}</strong><br><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${today.toLocaleDateString('ar-EG')} - ${today.toLocaleTimeString('ar-EG')}</strong>`;
          
          // Insert after header
          const header = document.querySelector('.header');
          header.parentNode.insertBefore(printDateDiv, header.nextSibling);
          
          // Hide elements that shouldn't be printed
          const hideElements = document.querySelectorAll('.search-box input');
          hideElements.forEach(el => {
              el.style.display = 'none';
          });

          // Trigger print
          window.print();
          
          // Clean up after print
          setTimeout(() => {
              printDateDiv.remove();
              hideElements.forEach(el => {
                  el.style.display = '';
              });
          }, 1000);
      }

      // Export to Excel function
      function exportToExcel() {
          if (students.length === 0) {
              alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
              return;
          }

          const selectedDate = document.getElementById('attendanceDate').value;
          const today = new Date();
          const dateStr = selectedDate || today.toISOString().split('T')[0];
          
          // Prepare data for Excel
          const excelData = students.map((student, index) => {
              const status = attendanceData[student.id] || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
              const statusText = status === 'present' ? 'Ø­Ø§Ø¶Ø±' : 
                               status === 'absent' ? 'ØºØ§Ø¦Ø¨' : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
              
              return {
                  'Ø§Ù„Ø±Ù‚Ù…': index + 1,
                  'Ø§Ù„Ø§Ø³Ù…': student.name,
                  'Ø§Ù„ÙØ±ÙŠÙ‚': student.team,
                  'Ø§Ù„Ø­Ø§Ù„Ø©': statusText,
                  'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': student.email,
                  'Ø§Ù„ØªØ§Ø±ÙŠØ®': dateStr
              };
          });

          // Create summary data
          const totalStudents = students.length;
          const presentCount = Object.values(attendanceData).filter(status => status === 'present').length;
          const absentCount = Object.values(attendanceData).filter(status => status === 'absent').length;
          const notMarkedCount = totalStudents - presentCount - absentCount;

          const summaryData = [
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨', 'Ø§Ù„Ø¹Ø¯Ø¯': totalStudents },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„Ø­Ø§Ø¶Ø±ÙˆÙ†', 'Ø§Ù„Ø¹Ø¯Ø¯': presentCount },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†', 'Ø§Ù„Ø¹Ø¯Ø¯': absentCount },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'Ø§Ù„Ø¹Ø¯Ø¯': notMarkedCount },
              { 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©': 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¹Ø¯Ø¯': dateStr }
          ];

          // Create workbook
          const wb = XLSX.utils.book_new();
          
          // Create attendance sheet
          const ws1 = XLSX.utils.json_to_sheet(excelData);
          XLSX.utils.book_append_sheet(wb, ws1, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±');
          
          // Create summary sheet
          const ws2 = XLSX.utils.json_to_sheet(summaryData);
          XLSX.utils.book_append_sheet(wb, ws2, 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');

          // Save the Excel file
          XLSX.writeFile(wb, `attendance_report_${dateStr}.xlsx`);
      }

      // Mobile menu toggle function
      function toggleMobileMenu() {
          const navMenu = document.getElementById('navMenu');
          navMenu.classList.toggle('active');
      }

      // Logout function
      function logout() {
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
              localStorage.removeItem('userToken');
              sessionStorage.clear();
              window.location.href = 'index.html';
          }
      }

      // Load students on page load
      window.onload = function() {
          loadStudents();
      };

      // Close mobile menu when clicking on a link
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
          link.addEventListener('click', function() {
              const navMenu = document.getElementById('navMenu');
              navMenu.classList.remove('active');
          });
      });
      
      function showMessage(type) {
          const success = document.getElementById("successMessage");
          const error = document.getElementById("errorMessage");

          success.style.display = "none";
          error.style.display = "none";

          if (type === "success") {
              success.style.display = "block";
              setTimeout(() => success.style.display = "none", 3000);
          } else if (type === "error") {
              error.style.display = "block";
              setTimeout(() => error.style.display = "none", 3000);
          }
      }

      document.querySelector('.menu-toggle').addEventListener('click', function () {
  document.querySelector('.nav-right').classList.toggle('show');
});

  </script>
</div>
</body>
</html>
