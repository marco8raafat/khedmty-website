<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سجل الحضور</title>
  <link rel="stylesheet" href="styleAttendance.css">
  
</head>
<style>

.export-buttons {
  display: flex;
  gap: 10px; 
  margin-top: 10px;
}

.export-buttons button {
  flex: 1; 
  height: 45px;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  border-radius: 5px;
  color: white;
  cursor: pointer;
  transition: 0.3s;
}

.btn-primary {
  background-color: var(--primary);
}

.btn-success {
  background-color: var(--success);
}

.export-buttons button:hover {
  filter: brightness(1.1);
}
</style>


<body>
  <nav class="navbar">
    <div class="logo">
      <img src="church-logo.png" alt="شعار الموقع">
      <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    </div>
<div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="teacherDashboard.html" class="nav-link">لوحة التحكم</a>
      <a href="AttendanceData.html" class="nav-link">أخذ الحضور</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">تسجيل الخروج</a>
    </div>
  </nav>

  <div class="container">
    <main>
      <h2>سجل الحضور</h2>
      <div class="export-buttons">
        <button class="btn-primary" onclick="printAttendance()">🖨️ طباعة / تحميل PDF</button>
        <button class="btn-success" onclick="exportToExcel()">📊 تصدير Excel</button>
      </div>

      <div class="controls">
        <input type="text" id="searchInput" placeholder="ابحث بالاسم أو التاريخ" oninput="filterAttendanceHistory()">

        <label for="dateSelect">اختر التاريخ:</label>

        <select id="dateSelect">
          <option value="">-- تحميل التواريخ --</option>
        </select>
        <button onclick="fetchAttendanceByDate()">عرض الحضور</button>
      </div>

      <div class="table-container">
        <table id="historyTable">
        <thead>
            <tr>
              <th>الاسم</th>
              <th>المجموعة</th>
              <th>الحالة</th>
            </tr>
          </thead>
          <tbody id="attendanceBody">
            <tr><td colspan="3" class="empty-state">يرجى اختيار تاريخ لعرض الحضور</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>


  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
      authDomain: "edad-5odam.firebaseapp.com",
      databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "edad-5odam",
      storageBucket: "edad-5odam.appspot.com",
      messagingSenderId: "679576633778",
      appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function checkAuth() {
      const currentUser = sessionStorage.getItem("currentUser");
      if (!currentUser) {
        alert("يجب تسجيل الدخول أولاً للوصول إلى هذه الصفحة");
        window.location.href = "login.html";
        return false;
      }
      return true;
    }

    function toggleMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      navMenu.classList.toggle('active');
    }

    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        sessionStorage.removeItem("currentUser");
        alert("تم تسجيل الخروج بنجاح!");
        window.location.href = "login.html";
      }
    }

    async function loadAvailableDates() {
      try {
        const snapshot = await db.ref('attendance').once('value');
        const data = snapshot.val();
        const dateSelect = document.getElementById('dateSelect');
        dateSelect.innerHTML = '<option value="">-- اختر التاريخ --</option>';

        if (data) {
          const dates = Object.keys(data).sort((a, b) => new Date(b) - new Date(a));
          dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = new Date(date).toLocaleDateString('ar-EG', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              weekday: 'long'
            });
            dateSelect.appendChild(option);
          });
        } else {
          dateSelect.innerHTML = '<option value="">لا توجد تواريخ متاحة</option>';
        }
      } catch (error) {
        console.error("Error loading dates:", error);
        alert("❌ حدث خطأ أثناء تحميل التواريخ");
      }
    }

    async function fetchAttendanceByDate() {
      if (!checkAuth()) return;

      const date = document.getElementById('dateSelect').value;
      const tbody = document.getElementById('attendanceBody');
      tbody.innerHTML = '';

      if (!date) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">❌ الرجاء اختيار تاريخ</td></tr>';
        return;
      }

      try {
        const snapshot = await db.ref('attendance/' + date).once('value');
        const data = snapshot.val();

        if (!data) {
          tbody.innerHTML = '<tr><td colspan="3">📭 لا توجد بيانات لهذا اليوم</td></tr>';
          return;
        }

        Object.keys(data).forEach(studentId => {
          const record = data[studentId];
          const row = document.createElement('tr');

          const nameCell = document.createElement('td');
          nameCell.textContent = record.studentName || 'غير معروف';

          const teamCell = document.createElement('td');
          teamCell.textContent = record.team || 'غير محدد';

          const statusCell = document.createElement('td');
          statusCell.textContent = record.status === 'present' ? 'حاضر ✅' : 'غائب ❌';
          statusCell.className = record.status === 'present' ? 'status-present' : 'status-absent';

          row.appendChild(nameCell);
          row.appendChild(teamCell);
          row.appendChild(statusCell);

          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Error fetching data:', error);
        tbody.innerHTML = '<tr><td colspan="3">❌ حدث خطأ أثناء تحميل البيانات</td></tr>';
      }
    }

    window.onload = function() {
      checkAuth();
      loadAvailableDates();
    };
    document.querySelector('.menu-toggle').addEventListener('click', function () {
  document.querySelector('.nav-right').classList.toggle('show');
});

function printAttendance() {
    const printContents = document.getElementById("historyTable").outerHTML;
    const printWindow = window.open("", "", "height=600,width=800");
    printWindow.document.write("<html><head><title>سجل الحضور</title>");
    printWindow.document.write("<style>");
    printWindow.document.write("table { width: 100%; border-collapse: collapse; direction: rtl; font-family: Arial; }");
    printWindow.document.write("th, td { border: 1px solid black; padding: 10px; text-align: center; }");
    printWindow.document.write("</style>");
    printWindow.document.write("</head><body>");
    printWindow.document.write("<h2>سجل الحضور</h2>");
    printWindow.document.write(printContents);
    printWindow.document.write("</body></html>");
    printWindow.document.close();
    printWindow.print();
  }
  function filterAttendanceHistory() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#attendanceBody tr");

  rows.forEach(row => {
    const name = row.cells[0]?.textContent.toLowerCase() || "";
    const team = row.cells[1]?.textContent.toLowerCase() || "";
    const status = row.cells[2]?.textContent.toLowerCase() || "";

    if (name.includes(input) || team.includes(input) || status.includes(input)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}


  </script>
  <script>
    loadAttendanceHistory();
  </script>

</body>
</html>


