<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logoCircle1.png">
  <title>المصادر التعليمية</title>
  <link rel="stylesheet" href="listPDF.css">
</head>
<body>
<div class="cross-background"></div>
  <nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    </div>
 <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="studentDashboard.html" class="nav-link">لوحة التحكم</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">تسجيل الخروج</a>
    </div>
  </nav>

  <div class="container">
    <main>
      <h2 class="section-title">المصادر التعليمية المرفوعة</h2>
      <div class="filter-group">
        <label for="subjectFilter">تصفية حسب المادة:</label>
        <select id="subjectFilter">
          <option value="all">الكل</option>
        </select>
      </div>
      <div id="pdfList" class="pdf-list">
        <div class="empty-state">
          <p>لا توجد مصادر تعليمية مرفوعة حاليًا</p>
        </div>
      </div>
    </main>
  </div>

  <footer>
    © كنيسة السيدة العذراء - عزبة النخل | تطبيق خدمتي 2025
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="sessionUtils.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
      authDomain: "edad-5odam.firebaseapp.com",
      databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "edad-5odam",
      storageBucket: "edad-5odam.appspot.com",
      messagingSenderId: "679576633778",
      appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Smart Cache Management System for Student PDFs
    class StudentPDFCache {
      constructor() {
        this.cache = new Map();
        this.listeners = new Map();
        this.lastUpdated = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5 minutes cache expiry
      }

      // Check if cached data is still valid
      isCacheValid(path) {
        const lastUpdate = this.lastUpdated.get(path);
        if (!lastUpdate) return false;
        return (Date.now() - lastUpdate) < this.cacheExpiry;
      }

      // Get data from cache or Firebase with real-time listener
      async getData(path, callback) {
        // If we have valid cached data, use it immediately
        if (this.isCacheValid(path) && this.cache.has(path)) {
          console.log(`[Student PDFs] Using cached data for ${path}`);
          if (callback) callback(this.cache.get(path));
          return this.cache.get(path);
        }

        // Set up real-time listener if not already exists
        if (!this.listeners.has(path)) {
          console.log(`[Student PDFs] Setting up real-time listener for ${path}`);
          const listener = db.ref(path).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            this.cache.set(path, data);
            this.lastUpdated.set(path, Date.now());
            console.log(`[Student PDFs] Data updated for ${path}:`, Object.keys(data).length, 'PDFs');
            if (callback) callback(data);
          });
          this.listeners.set(path, listener);
        }

        // Return cached data if available, otherwise return empty object
        return this.cache.get(path) || {};
      }

      // Clean up listeners when not needed
      cleanup() {
        this.listeners.forEach((listener, path) => {
          db.ref(path).off('value', listener);
        });
        this.listeners.clear();
        this.cache.clear();
        this.lastUpdated.clear();
      }
    }

    // Initialize cache instance
    const studentPDFCache = new StudentPDFCache();

    // Debounce function to prevent rapid successive updates
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Mobile menu toggle function
    function toggleMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      navMenu.classList.toggle('active');
    }
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const pdfList = document.getElementById('pdfList');
    const subjectFilter = document.getElementById('subjectFilter');
  
    if (!pdfList || !subjectFilter) {
      console.error('Required elements missing:', {
        pdfList: !!pdfList,
        subjectFilter: !!subjectFilter
      });
      return;
    }

    // Check if Firebase is available
    if (typeof firebase === 'undefined' || !firebase.database) {
      console.error('Firebase not available');
      displayEmptyState();
      return;
    }

    let allPdfs = [];
  
    // Fetch PDFs from Firebase with smart caching
    const debouncedProcessPDFs = debounce(processPDFData, 200);
    
    function fetchPDFs() {
      displayLoading();
      
      // Use smart caching for educational resources
      studentPDFCache.getData('educational-resources', (data) => {
        debouncedProcessPDFs(data);
      });
    }

    // Process PDF data from cache or Firebase
    function processPDFData(data) {
      allPdfs = [];
      
      if (data && Object.keys(data).length > 0) {
        Object.values(data).forEach((pdf) => {
          if (pdf) {
            allPdfs.push(pdf);
          }
        });
        
        console.log('[Student PDFs] Processed PDFs:', allPdfs.length);
        populateSubjectFilter();
        renderPDFs('all');
      } else {
        console.log('[Student PDFs] No educational resources found');
        displayEmptyState();
      }
    }

    // Populate subject filter dropdown
    function populateSubjectFilter() {
      const subjects = [...new Set(allPdfs.map(pdf => pdf.subject || 'غير محدد'))].sort();
      
      // Clear existing options except "All"
      subjectFilter.innerHTML = '<option value="all">الكل</option>';
      
      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectFilter.appendChild(option);
      });
    }

    // Debounced render function for smooth filtering
    const debouncedRender = debounce((filterSubject) => {
      renderPDFs(filterSubject);
    }, 200);
  
    // Display PDFs based on filter (students can only view, not delete)
    function renderPDFs(filterSubject) {
      pdfList.innerHTML = ''; // Clear current list
      const filteredPDFs = filterSubject === 'all' ? allPdfs : allPdfs.filter(pdf => (pdf.subject || 'غير محدد') === filterSubject);
  
      if (filteredPDFs.length === 0) {
        displayEmptyState();
        return;
      }
  
      filteredPDFs.forEach(pdf => {
        const pdfItem = document.createElement('div');
        pdfItem.className = 'pdf-item';
  
        const pdfTitle = document.createElement('span');
        pdfTitle.className = 'pdf-title';
        pdfTitle.textContent = pdf.title;

        const pdfSubject = document.createElement('span');
        pdfSubject.className = 'pdf-subject';
        pdfSubject.textContent = `المادة: ${pdf.subject || 'غير محدد'}`;
  
        const pdfActions = document.createElement('div');
        pdfActions.className = 'pdf-actions';
  
        // View button (only action for students)
        const viewLink = document.createElement('a');
        viewLink.href = pdf.link; // Use the link from Firebase
        viewLink.textContent = 'عرض';
        viewLink.setAttribute('target', '_blank'); // Open in new tab
        viewLink.classList.add('firstB');

        // Share button
        const shareButton = document.createElement('button');
        shareButton.textContent = 'مشاركة';
        shareButton.className = 'share-button-pdf';
        shareButton.onclick = function() {
          sharePDF(pdf.link, pdf.title || 'مصدر تعليمي من الكنيسة');
        };
  
        pdfActions.appendChild(viewLink);
        pdfActions.appendChild(shareButton);
        pdfItem.appendChild(pdfTitle);
        pdfItem.appendChild(pdfSubject);
        pdfItem.appendChild(pdfActions);
        pdfList.appendChild(pdfItem);
      });
    }
  
    // Initial load
    fetchPDFs();
  
    // Filter change event with debouncing
    subjectFilter.addEventListener('change', (e) => {
      console.log('[Student PDFs] Filtering by subject:', e.target.value);
      debouncedRender(e.target.value);
    });

    // Clean up cache and listeners when page is about to unload
    window.addEventListener('beforeunload', () => {
      studentPDFCache.cleanup();
    });

    // Close mobile menu when clicking on a link
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function() {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.remove('active');
      });
    });

    function displayLoading() {
      pdfList.innerHTML = `
        <div class="empty-state">
          <p>جاري تحميل المصادر التعليمية...</p>
        </div>
      `;
      console.log('Displayed loading state');
    }
  
    function displayEmptyState() {
      pdfList.innerHTML = `
        <div class="empty-state">
          <p>لا توجد مصادر تعليمية مرفوعة حاليًا</p>
        </div>
      `;
      console.log('Displayed empty state');
    }
  });
          // Logout function
    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        clearSession();
        window.location.href = "index.html";
      }
    }

    // Share PDF functionality
    function sharePDF(pdfUrl, title) {
      // Check if Web Share API is supported
      if (navigator.share && navigator.canShare) {
        navigator.share({
          title: title || 'مصدر تعليمي من الكنيسة',
          text: `شاهد هذا المصدر التعليمي: ${title}`,
          url: pdfUrl
        }).catch(error => {
          console.log('Error sharing:', error);
          fallbackSharePDF(pdfUrl, title);
        });
      } else {
        fallbackSharePDF(pdfUrl, title);
      }
    }

    // Fallback share function for browsers that don't support Web Share API
    function fallbackSharePDF(pdfUrl, title) {
      const textToCopy = `${title}\n${pdfUrl}`;
      
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy).then(() => {
          showPDFNotification('تم نسخ رابط المصدر التعليمي إلى الحافظة!', 'success');
        }).catch(() => {
          // Fallback for older browsers
          copyToClipboardFallbackPDF(textToCopy);
        });
      } else {
        copyToClipboardFallbackPDF(textToCopy);
      }
    }

    // Legacy clipboard copy method for PDFs
    function copyToClipboardFallbackPDF(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        showPDFNotification('تم نسخ رابط المصدر التعليمي إلى الحافظة!', 'success');
      } catch (err) {
        showPDFNotification('فشل في نسخ الرابط', 'error');
      }
      
      document.body.removeChild(textArea);
    }

    // Simple notification system for PDFs
    function showPDFNotification(message, type = 'info', duration = 3000) {
      // Remove existing notification
      const existing = document.querySelector('.pdf-notification');
      if (existing) {
        existing.remove();
      }

      const notification = document.createElement('div');
      notification.className = 'pdf-notification';
      
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
      };
      
      notification.innerHTML = `
        <div style="
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${colors[type]};
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          font-weight: 600;
          font-size: 14px;
          max-width: 300px;
          word-wrap: break-word;
        ">
          ${message}
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, duration);
    }

    const container = document.querySelector('.cross-background');

  const svgCross = `
  <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!-- License: CC0. Made by SVG Repo: https://www.svgrepo.com/svg/90761/cross -->
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 60 60" style="enable-background:new 0 0 60 60;" xml:space="preserve">
<path d="M52.247,19.665c-0.396,0-0.785,0.049-1.162,0.145c-0.403-2.214-2.347-3.897-4.675-3.897c-2.396,0-4.382,1.781-4.707,4.087
	H35v-4.811c2.077-0.517,3.594-2.381,3.594-4.599c0-2.188-1.486-4.036-3.503-4.586c0.11-0.404,0.167-0.824,0.167-1.251
	C35.258,2.132,33.126,0,30.506,0c-2.621,0-4.753,2.132-4.753,4.753c0,0.395,0.049,0.785,0.145,1.162C23.684,6.318,22,8.262,22,10.59
	c0,2.364,1.735,4.331,4,4.693V20h-7.812c-0.516-2.077-2.38-3.594-4.599-3.594c-2.188,0-4.035,1.486-4.585,3.503
	c-0.405-0.11-0.825-0.167-1.252-0.167C5.132,19.742,3,21.874,3,24.495s2.132,4.753,4.753,4.753c0.396,0,0.785-0.049,1.162-0.145
	C9.318,31.316,11.262,33,13.59,33c2.365,0,4.332-1.736,4.693-4H26v15.84c-2.026,0.551-3.506,2.405-3.506,4.569
	c0,2.188,1.486,4.036,3.502,4.586c-0.11,0.405-0.167,0.825-0.167,1.252c0,2.621,2.132,4.752,4.753,4.752s4.753-2.132,4.753-4.752
	c0-0.395-0.049-0.785-0.146-1.162c2.215-0.404,3.898-2.347,3.898-4.676c0-2.395-1.781-4.382-4.088-4.706V29h6.84
	c0.552,2.027,2.406,3.506,4.57,3.506c2.188,0,4.035-1.486,4.585-3.503c0.405,0.11,0.825,0.167,1.252,0.167
	c2.621,0,4.753-2.132,4.753-4.752S54.868,19.665,52.247,19.665z"/>
</svg>

  `;

 const isMobile = window.innerWidth < 768;
const crossCount = isMobile ? 10 : 25;

for (let i = 0; i < crossCount; i++) {
  const cross = document.createElement('div');
  cross.className = 'cross';
  cross.innerHTML = svgCross;
  cross.style.left = Math.random() * 100 + 'vw';
  cross.style.top = Math.random() * 100 + 'vh';
  cross.style.animationDuration = (12 + Math.random() * 11) + 's';
  container.appendChild(cross);
}
  </script>
</body>
</html>