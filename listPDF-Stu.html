<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logoCircle1.png">
  <title>المصادر التعليمية</title>
  <link rel="stylesheet" href="listPDF.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="Church Logo" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    </div>
 <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="teacherDashboard.html" class="nav-link">لوحة التحكم</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" onclick="logout()" class="nav-link">تسجيل الخروج</a>
    </div>
  </nav>

  <div class="container">
    <main>
      <h2 class="section-title">المصادر التعليمية المرفوعة</h2>
      <div class="filter-group">
        <label for="subjectFilter">تصفية حسب المادة:</label>
        <select id="subjectFilter">
          <option value="all">الكل</option>
        </select>
      </div>
      <div id="pdfList" class="pdf-list">
        <div class="empty-state">
          <p>لا توجد مصادر تعليمية مرفوعة حاليًا</p>
        </div>
      </div>
    </main>
  </div>

  <footer>
    © كنيسة السيدة العذراء - عزبة النخل | تطبيق خدمتي 2025
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
      authDomain: "edad-5odam.firebaseapp.com",
      databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "edad-5odam",
      storageBucket: "edad-5odam.appspot.com",
      messagingSenderId: "679576633778",
      appId: "1:679576633778:web:566e6aaef9b72f71a824ab"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Smart Cache Management System for Student PDFs
    class StudentPDFCache {
      constructor() {
        this.cache = new Map();
        this.listeners = new Map();
        this.lastUpdated = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5 minutes cache expiry
      }

      // Check if cached data is still valid
      isCacheValid(path) {
        const lastUpdate = this.lastUpdated.get(path);
        if (!lastUpdate) return false;
        return (Date.now() - lastUpdate) < this.cacheExpiry;
      }

      // Get data from cache or Firebase with real-time listener
      async getData(path, callback) {
        // If we have valid cached data, use it immediately
        if (this.isCacheValid(path) && this.cache.has(path)) {
          console.log(`[Student PDFs] Using cached data for ${path}`);
          if (callback) callback(this.cache.get(path));
          return this.cache.get(path);
        }

        // Set up real-time listener if not already exists
        if (!this.listeners.has(path)) {
          console.log(`[Student PDFs] Setting up real-time listener for ${path}`);
          const listener = db.ref(path).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            this.cache.set(path, data);
            this.lastUpdated.set(path, Date.now());
            console.log(`[Student PDFs] Data updated for ${path}:`, Object.keys(data).length, 'PDFs');
            if (callback) callback(data);
          });
          this.listeners.set(path, listener);
        }

        // Return cached data if available, otherwise return empty object
        return this.cache.get(path) || {};
      }

      // Clean up listeners when not needed
      cleanup() {
        this.listeners.forEach((listener, path) => {
          db.ref(path).off('value', listener);
        });
        this.listeners.clear();
        this.cache.clear();
        this.lastUpdated.clear();
      }
    }

    // Initialize cache instance
    const studentPDFCache = new StudentPDFCache();

    // Debounce function to prevent rapid successive updates
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Mobile menu toggle function
    function toggleMobileMenu() {
      const navMenu = document.getElementById('navMenu');
      navMenu.classList.toggle('active');
    }
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const pdfList = document.getElementById('pdfList');
    const subjectFilter = document.getElementById('subjectFilter');
  
    if (!pdfList || !subjectFilter) {
      console.error('Required elements missing:', {
        pdfList: !!pdfList,
        subjectFilter: !!subjectFilter
      });
      return;
    }

    // Check if Firebase is available
    if (typeof firebase === 'undefined' || !firebase.database) {
      console.error('Firebase not available');
      displayEmptyState();
      return;
    }

    let allPdfs = [];
  
    // Fetch PDFs from Firebase with smart caching
    const debouncedProcessPDFs = debounce(processPDFData, 200);
    
    function fetchPDFs() {
      displayLoading();
      
      // Use smart caching for educational resources
      studentPDFCache.getData('educational-resources', (data) => {
        debouncedProcessPDFs(data);
      });
    }

    // Process PDF data from cache or Firebase
    function processPDFData(data) {
      allPdfs = [];
      
      if (data && Object.keys(data).length > 0) {
        Object.values(data).forEach((pdf) => {
          if (pdf) {
            allPdfs.push(pdf);
          }
        });
        
        console.log('[Student PDFs] Processed PDFs:', allPdfs.length);
        populateSubjectFilter();
        renderPDFs('all');
      } else {
        console.log('[Student PDFs] No educational resources found');
        displayEmptyState();
      }
    }

    // Populate subject filter dropdown
    function populateSubjectFilter() {
      const subjects = [...new Set(allPdfs.map(pdf => pdf.subject || 'غير محدد'))].sort();
      
      // Clear existing options except "All"
      subjectFilter.innerHTML = '<option value="all">الكل</option>';
      
      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectFilter.appendChild(option);
      });
    }

    // Debounced render function for smooth filtering
    const debouncedRender = debounce((filterSubject) => {
      renderPDFs(filterSubject);
    }, 200);
  
    // Display PDFs based on filter (students can only view, not delete)
    function renderPDFs(filterSubject) {
      pdfList.innerHTML = ''; // Clear current list
      const filteredPDFs = filterSubject === 'all' ? allPdfs : allPdfs.filter(pdf => (pdf.subject || 'غير محدد') === filterSubject);
  
      if (filteredPDFs.length === 0) {
        displayEmptyState();
        return;
      }
  
      filteredPDFs.forEach(pdf => {
        const pdfItem = document.createElement('div');
        pdfItem.className = 'pdf-item';
  
        const pdfTitle = document.createElement('span');
        pdfTitle.className = 'pdf-title';
        pdfTitle.textContent = pdf.title;

        const pdfSubject = document.createElement('span');
        pdfSubject.className = 'pdf-subject';
        pdfSubject.textContent = `المادة: ${pdf.subject || 'غير محدد'}`;
  
        const pdfActions = document.createElement('div');
        pdfActions.className = 'pdf-actions';
  
        // View button (only action for students)
        const viewLink = document.createElement('a');
        viewLink.href = pdf.link; // Use the link from Firebase
        viewLink.textContent = 'عرض';
        viewLink.setAttribute('target', '_blank'); // Open in new tab
        viewLink.classList.add('firstB');
  
        pdfActions.appendChild(viewLink);
        pdfItem.appendChild(pdfTitle);
        pdfItem.appendChild(pdfSubject);
        pdfItem.appendChild(pdfActions);
        pdfList.appendChild(pdfItem);
      });
    }
  
    // Initial load
    fetchPDFs();
  
    // Filter change event with debouncing
    subjectFilter.addEventListener('change', (e) => {
      console.log('[Student PDFs] Filtering by subject:', e.target.value);
      debouncedRender(e.target.value);
    });

    // Clean up cache and listeners when page is about to unload
    window.addEventListener('beforeunload', () => {
      studentPDFCache.cleanup();
    });

    // Close mobile menu when clicking on a link
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function() {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.remove('active');
      });
    });

    function displayLoading() {
      pdfList.innerHTML = `
        <div class="empty-state">
          <p>جاري تحميل المصادر التعليمية...</p>
        </div>
      `;
      console.log('Displayed loading state');
    }
  
    function displayEmptyState() {
      pdfList.innerHTML = `
        <div class="empty-state">
          <p>لا توجد مصادر تعليمية مرفوعة حاليًا</p>
        </div>
      `;
      console.log('Displayed empty state');
    }
  });
          // Logout function
    function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        sessionStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }
    }
  </script>
</body>
</html>