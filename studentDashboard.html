<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="logoCircle1.png">
  <title>لوحة تحكم الطالب - خدمتي</title>
  <style>
  body {
  font-family: "Cairo", sans-serif;
  /* background: linear-gradient(to bottom right, #eaf1ff, #dbe5ff); */
  color: #222;
  margin: 0;
  padding: 0;
  direction: rtl;
  min-height: 100vh;
  background-image: url('knesa.jpg'); /* Change path to your image */
  background-size: cover;        /* Make image cover the whole page */
  background-repeat: no-repeat;  /* Prevent repeating */
  /* background-attachment: fixed;  Keeps background fixed when scrolling */
  background-position: center;   /* Center the image */
  font-family: 'Arial', sans-serif;
}
/* Mobile menu toggle button */
.menu-toggle {
  display: none;
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 8px;
  border-radius: 4px;
  transition: background-color 0.3s;
}

.menu-toggle:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

/* Mobile responsive styles */
@media (max-width: 768px) {
  .navbar {
    flex-direction: column;
    padding: 10px;
  }

  .nav-left {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .nav-left .church-logo {
    height: 60px;
  }

  .menu-toggle {
    display: block;
  }

  .nav-right {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .nav-right.active {
    max-height: 300px;
  }

  .nav-link {
    width: 100%;
    text-align: center;
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0;
  }

  .nav-link:last-child {
    border-bottom: none;
  }
}

.navbar {
  background-color: #233B6E;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.nav-left .church-logo {
  height: 60px;
  border: 3px solid #fff;
  border-radius: 12px;
  padding: 4px;
  background-color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.nav-right .nav-link {
  color: white;
  text-decoration: none;
  margin-left: 15px;
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 6px;
  transition: 0.3s;
}

.nav-right .nav-link:hover,
.nav-right .nav-link:focus,
.nav-right .nav-link:active {
  background-color: #1a2d59;
  color: #fff;
  text-decoration: none;
}

header {
  background-color:  #ffffff52;
  text-align: center;
  padding: 40px 20px 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  border-bottom: 3px solid #233B6E22;
  border-radius: 0 0 25px 25px;
  font-weight:700;
}

.logo {
  width: 90px;
  height: auto;
  margin-bottom: 10px;
  transition: transform 0.3s;
}

.logo:hover {
  transform: scale(1.1);
}

h1 {
  margin: 10px 0 5px;
  font-size: 2.5em;
  color: #233B6E;
}

.tagline {
  font-size: 1.1em;
  color: #555;
}

main {
  flex: 1;
  padding: 30px 20px;
  max-width: 800px;
  margin: 0 auto;
  font-weight:600;
}

section {
  margin-bottom: 40px;
  background-color: #ffffff66;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

h2 {
  color: #233B6E;
  margin-bottom: 10px;
}

p {
  line-height: 1.8;
  font-size: 1.05em;
}

.btn {
  display: inline-block;
  background: linear-gradient(to right, #233B6E, #314d9f);
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
  margin: 10px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease-in-out;
}

.btn:hover {
  background: #1a2d59;
  transform: scale(1.05);
}

footer {
  background-color: #233B6E;
  color: white;
  text-align: center;
  padding: 15px;
  font-size: 0.9em;
  margin-top: auto;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
}

.container {
   background-color: white;
  padding: 30px;
  max-width: 650px;
  width: 80%; 
  margin: 60px auto;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.container h2 {
  text-align: center;
  color: #233B6E;
  margin-bottom: 20px;
}

input[type="text"],
input[type="email"],
input[type="password"],
input[type="tel"] {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1.05em;
}

label {
  font-weight: bold;
  color: #233B6E;
}

.back-icon {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 1.2em;
  color: #233B6E;
  text-decoration: none;
}

.role-options {
  display: flex;
  gap: 20px;
  margin-top: -10px;
  font-weight: normal;
}
  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: inherit;
    
    z-index: -1;
  }
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .welcome-section {
      background: linear-gradient(135deg, #233B6E, #314d9f);
      color: white;
      padding: 40px 30px;
      border-radius: 20px;
      text-align: center;
      margin-bottom: 40px;
      box-shadow: 0 8px 25px rgba(9, 9, 9, 0.3);
    }

    .welcome-section h1 {
      font-size: 2.5em;
      margin-bottom: 15px;
      color: white;
    }

    .welcome-section p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .dashboard-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #233B6E, #314d9f);
    }

    .dashboard-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
      border-color: #233B6E;
    }

    .card-icon {
      font-size: 3em;
      margin-bottom: 20px;
      color: #233B6E;
    }

    .card-title {
      font-size: 1.4em;
      color: #233B6E;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .card-description {
      color: #666;
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .card-btn {
      background: linear-gradient(45deg, #233B6E, #314d9f);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .card-btn:hover {
      background: linear-gradient(45deg, #1a2d59, #233B6E);
      transform: scale(1.02);
    }

    .notifications-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      margin-bottom: 40px;
    }

    .notifications-section h3 {
      color: #233B6E;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #latestNotifications {
      transition: opacity 0.3s ease;
    }

    .notification-item {
      background: #f8fff8;
      border: 1px solid #e8f5e8;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #233B6E;
      transition: all 0.3s ease;
    }

    .notification-item:hover {
      transform: translateX(-3px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .notification-title {
      font-weight: bold;
      color: #233B6E;
      margin-bottom: 5px;
    }

    .notification-message {
      color: #666;
      margin-bottom: 8px;
    }

    .notification-time {
      font-size: 0.9em;
      color: #999;
    }

    .quick-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-bottom: 40px;
    }

    .quick-link {
      background: linear-gradient(135deg,rgb(255, 255, 255),rgb(252, 252, 252));
      color: #233B6E;
      padding: 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      text-align: center;
      border: 2px solid transparent;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    .quick-link:hover {
      border-color: #233B6E;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(56, 142, 60, 0.2);
    }

    .study-progress {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      text-align: center;
    }

    .study-progress h3 {
      color: #233B6E;
      margin-bottom: 20px;
      font-size: 1.3em;
    }

    .progress-bar {
      background: #e8f5e8;
      border-radius: 20px;
      height: 25px;
      margin: 20px 0;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
      background: linear-gradient(45deg, #1a2d59, #233B6E, #314d9f);
      height: 100%;
      width: 0%;
      border-radius: 20px;
      transition: width 0.8s ease-in-out;
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.3) 50%, transparent 70%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      color: #233B6E;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.1em;
    }

    .progress-details {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      border-left: 4px solid #233B6E;
    }

    .loading-progress .progress-fill {
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: -200px 0; }
      100% { background-position: 200px 0; }
    }

    .refresh-btn {
      background: none;
      border: none;
      color: #233B6E;
      margin-left: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      color: white;
      transform: rotate(180deg);
    }

    .refresh-btn:active {
      transform: rotate(360deg);
    }

    .empty-notifications {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .quick-links {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }
      
      .welcome-section h1 {
        font-size: 2em;
      }
      
      .dashboard-card {
        padding: 20px;
      }
    }
.cross-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
  overflow: hidden;
}
.glowing-cross {
    font-size: 50px;
    color: white;
    opacity: 0.6;
    filter: drop-shadow(0 0 8px rgba(173, 216, 230, 0.4));
    transition: all 0.3s ease;
    position: absolute;
    top: 40px;
    left: 40px;
  }

 
.cross {
  position: absolute;
  width: 30px;
  height: 30px;
  animation: float 12s linear infinite;
  opacity: 0.7;
  filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.6));
}

.cross svg {
  width: 100%;
  height: 100%;
  fill: rgba(255, 255, 255, 0.265);
}

@keyframes float {
  0% {
    transform: translateY(100vh) scale(1);
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    transform: translateY(-20vh) scale(1.3);
    opacity: 0;
  }
}   

  /* Loading overlay */
  .loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 9999;
  }
  .loading-overlay.hidden { display: none !important; }
  .loading-spinner {
    width: 56px;
    height: 56px;
    border: 6px solid rgba(255, 255, 255, 0.3);
    border-top-color: #233B6E;
    border-radius: 50%;
    animation: dash-spin 0.9s linear infinite;
  }
  .loading-text { margin-top: 12px; color: #fff; font-weight: 600; letter-spacing: 0.5px; }
  @keyframes dash-spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay hidden" role="status" aria-live="polite" aria-busy="true">
  <div class="loading-spinner" aria-hidden="true"></div>
  <div class="loading-text">جارٍ التحميل...</div>
</div>
<div class="cross-background"></div>
  <nav class="navbar">
    <div class="nav-left">
      <img src="church-logo.png" alt="شعار الكنيسة" class="church-logo">
      <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    </div>
    <div class="nav-right" id="navMenu">
      <a href="index.html" class="nav-link">الصفحة الرئيسية</a>
      <a href="profilepage.html" class="nav-link">الملف الشخصي</a>
      <a href="javascript:void(0)" class="nav-link" onclick="logout()">تسجيل الخروج</a>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="welcome-section">
      <h1>مرحباً بك   <span id="username">الطالب</span></h1>
      <p>منصتك التعليمية الشاملة للنمو الروحي والعلمي</p>
    </div>

    <div class="notifications-section">
      <h3>🔔 أحدث التنبيهات</h3>
      <div id="latestNotifications">
        <div class="empty-notifications">
          <p>لا توجد تنبيهات جديدة حالياً</p>
        </div>
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <a href="alerts-list.html" class="card-btn" style="width: auto; padding: 10px 20px;">عرض جميع التنبيهات</a>
      </div>
    </div>

    <div class="quick-links">
      <a href="index.html" class="quick-link">
        🏠<br>الصفحة الرئيسية
      </a>
      <a href="alerts-list.html" class="quick-link">
        🔔<br>التنبيهات
      </a>
      <a href="listPDF-Stu.html" class="quick-link">
        📚<br>المواد التعليمية
      </a>
      <a href="listPhotos-stu.html" class="quick-link">
        🖼️<br>معرض الصور
      </a>
      <a href="student-exam.html" class="quick-link">
        📝<br>الامتحانات
      </a>
      <a href="uploadResearch.html" class="quick-link">
        📋<br>تسليم البحوث
      </a>
      <a href="Grades.html" class="quick-link">
        📊<br>الدرجات
      </a>
      <a href="studentRank.html" class="quick-link">
        🏆<br>أفضل الطلاب
      </a>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-card">
        <div class="card-icon">🔔</div>
        <div class="card-title">التنبيهات والإعلانات</div>
        <div class="card-description">تابع آخر التنبيهات والإعلانات المهمة من خدامك</div>
        <a href="alerts-list.html" class="card-btn">عرض جميع التنبيهات</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">📚</div>
        <div class="card-title">المصادر التعليمية</div>
        <div class="card-description">تصفح وحمّل الكتب والمواد التعليمية المتاحة</div>
        <a href="listPDF-Stu.html" class="card-btn">تصفح المصادر</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">🖼️</div>
        <div class="card-title">معرض الصور</div>
        <div class="card-description">شاهد صور الأنشطة والفعاليات المختلفة</div>
        <a href="listPhotos-stu.html" class="card-btn">تصفح الصور</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">📝</div>
        <div class="card-title">الامتحانات الإلكترونية</div>
        <div class="card-description">أدخل الامتحانات الإلكترونية وتابع نتائجك</div>
        <a href="student-exam.html" class="card-btn">دخول الامتحان</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">📋</div>
        <div class="card-title">تسليم البحوث</div>
        <div class="card-description">ارفع وسلم البحوث والمشاريع المطلوبة منك</div>
        <a href="uploadResearch.html" class="card-btn">تسليم بحث</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">🧑‍🎓</div>
        <div class="card-title">الدرجات والنتائج</div>
        <div class="card-description">اطلع على درجاتك ونتائجك الأكاديمية في جميع المواد</div>
        <a href="Grades.html" class="card-btn">عرض الدرجات</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">👤</div>
        <div class="card-title">الملف الشخصي</div>
        <div class="card-description">إدارة بياناتك الشخصية ومعلومات الحساب</div>
        <a href="profilepage.html" class="card-btn">إدارة الملف</a>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">🏆</div>
        <div class="card-title">أفضل الطلاب</div>
        <div class="card-description">اطلع على ترتيب أفضل الطلاب حسب الحضور والمشاركة</div>
        <a href="studentRank.html" class="card-btn">عرض الترتيب</a>
      </div>
      
      <div class="dashboard-card">
        <div class="card-icon">🏠</div>
        <div class="card-title">الصفحة الرئيسية</div>
        <div class="card-description">العودة إلى الصفحة الرئيسية للتطبيق</div>
        <a href="index.html" class="card-btn">العودة للصفحة</a>
      </div>
    </div>

    <div class="study-progress">
      <h3>📈 تقدمك في التعلم 
        <button onclick="updateProgressDisplay()" class="refresh-btn" title="تحديث التقدم">🔄</button>
      </h3>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
      <div class="progress-text">
        جاري حساب التقدم...
      </div>
      <p style="color: #666; margin-top: 15px;">
        يتم حساب تقدمك بناءً على نسبة الحضور فقط
      </p>
    </div>
  </div>


  <footer>
    <p>© كنيسة السيدة العذراء - عزبة النخل | تطبيق خدمتي 2025</p>
  </footer>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="sessionUtils.js"></script>
<script>
  // Firebase configuration (replace only if different)
  const firebaseConfig = {
    apiKey: "AIzaSyDwcSo_bhqO5svMl3kAL8N1c91nvEZ_sac",
    authDomain: "edad-5odam.firebaseapp.com",
    databaseURL: "https://edad-5odam-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "edad-5odam",
    storageBucket: "edad-5odam.appspot.com",
    messagingSenderId: "679576633778",
    appId: "1:679576633778:web:566e6aaef9b72f71a824ab",
    measurementId: "G-7WB1WPDLRH"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Cache management system
  class DataCache {
    constructor() {
      this.cache = new Map();
      this.listeners = new Map();
      this.lastUpdated = new Map();
      this.cacheExpiry = 5 * 60 * 1000; // 5 minutes cache expiry
    }

    // Check if cached data is still valid
    isCacheValid(path) {
      const lastUpdate = this.lastUpdated.get(path);
      if (!lastUpdate) return false;
      return (Date.now() - lastUpdate) < this.cacheExpiry;
    }

    // Get data from cache or Firebase with real-time listener
    async getData(path, callback) {
      // If we have valid cached data, use it immediately
      if (this.isCacheValid(path) && this.cache.has(path)) {
        console.log(`[Student Dashboard] Using cached data for ${path}`);
        if (callback) callback(this.cache.get(path));
        return this.cache.get(path);
      }

      // Set up real-time listener if not already exists
      if (!this.listeners.has(path)) {
        console.log(`[Student Dashboard] Setting up real-time listener for ${path}`);
        const listener = database.ref(path).on('value', (snapshot) => {
          const data = snapshot.val() || {};
          this.cache.set(path, data);
          this.lastUpdated.set(path, Date.now());
          console.log(`[Student Dashboard] Data updated for ${path}:`, Object.keys(data).length, 'items');
          if (callback) callback(data);
        });
        this.listeners.set(path, listener);
      }

      // Return cached data if available, otherwise return empty object
      return this.cache.get(path) || {};
    }

    // Clean up listeners when not needed
    cleanup() {
      this.listeners.forEach((listener, path) => {
        database.ref(path).off('value', listener);
      });
      this.listeners.clear();
      this.cache.clear();
      this.lastUpdated.clear();
    }
  }

  // Initialize cache instance
  const dataCache = new DataCache();

  // Debounce function to prevent rapid successive updates
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // 🔐 Get current user with secure session verification
  const currentEmail = requireAuthentication();


  const emailKey = currentEmail.replace(/\./g, '_');

  // Enhanced user authentication with caching
  async function checkAuthentication() {
    console.log("[Student Dashboard] Checking authentication for:", currentEmail);
    
    if (!currentEmail) {
      window.location.href = "login.html";
      return false;
    }

    // Wait for user data to be loaded from cache/Firebase
    const userData = await new Promise((resolve) => {
      dataCache.getData(`users/${emailKey}`, (data) => {
        console.log("[Student Dashboard] User data loaded:", data);
        resolve(data);
      });
    });
    
    if (!userData || Object.keys(userData).length === 0) {
      console.log("[Student Dashboard] No user data found, redirecting to login");
      window.location.href = "login.html";
      return false;
    }

    const usernameElement = document.getElementById("username");
    if (usernameElement && userData.username) {
      const displayName = userData.username.split(" ").slice(0, 2).join(" ");
      console.log("[Student Dashboard] Setting username to:", displayName);
      usernameElement.textContent = displayName;
    }

    return true;
  }

  // 🔔 Load latest notifications
  document.addEventListener('DOMContentLoaded', async function() {
    const overlay = document.getElementById('loadingOverlay');
    try {
      if (overlay) overlay.classList.remove('hidden');

      console.log("[Student Dashboard] Initializing dashboard...");
      // Check authentication first
      const isAuthenticated = await checkAuthentication();
      if (!isAuthenticated) {
        return; // Exit if not authenticated (redirect handled elsewhere)
      }

      console.log("[Student Dashboard] User authenticated, setting up real-time updates...");
      // Setup real-time notifications listener
      loadLatestNotifications();

      // Calculate and display initial progress
      await updateProgressDisplay();

      // Real-time listener for alerts (auto-update notifications)
      dataCache.getData('alerts', () => {
        console.log("[Student Dashboard] Alerts updated, refreshing notifications...");
        if (typeof debouncedLoadNotifications === 'function') {
          debouncedLoadNotifications();
        } else {
          loadLatestNotifications();
        }
      });

      // Real-time listeners for attendance and research data (update progress)
      dataCache.getData('attendance', () => {
        console.log("[Student Dashboard] Attendance data updated, recalculating progress...");
        if (typeof debouncedUpdateProgress === 'function') {
          debouncedUpdateProgress();
        } else if (typeof updateProgressDisplay === 'function') {
          updateProgressDisplay();
        }
      });

      dataCache.getData('researches', () => {
        console.log("[Student Dashboard] Research data updated, recalculating progress...");
        if (typeof debouncedUpdateProgress === 'function') {
          debouncedUpdateProgress();
        } else if (typeof updateProgressDisplay === 'function') {
          updateProgressDisplay();
        }
      });

      console.log("[Student Dashboard] Dashboard setup complete with smart caching and progress tracking");

      // Periodic progress updates every 5 minutes
      setInterval(() => {
        console.log("[Student Dashboard] Periodic progress update");
        if (typeof updateProgressDisplay === 'function') {
          updateProgressDisplay();
        }
      }, 5 * 60 * 1000);
    } catch (e) {
      console.error("[Student Dashboard] Error during initialization:", e);
    } finally {
      if (overlay) overlay.classList.add('hidden');
    }
  });

  // 🔔 Enhanced notifications with smart caching
  function loadLatestNotifications() {
    console.log("[Student Dashboard] Loading notifications from cache...");
    
    // Use cached data with real-time listener
    dataCache.getData('alerts', (alertsData) => {
      const notificationsContainer = document.getElementById('latestNotifications');
      
      if (!alertsData || Object.keys(alertsData).length === 0) {
        notificationsContainer.innerHTML = `
          <div class="empty-notifications">
            <p>لا توجد تنبيهات جديدة حالياً</p>
          </div>
        `;
        return;
      }

      // Convert to array and sort by timestamp or order
      const alerts = Object.values(alertsData);
      const latestAlerts = alerts.slice(-3).reverse(); // Get last 3 alerts
      
      console.log("[Student Dashboard] Displaying", latestAlerts.length, "notifications");
      
      notificationsContainer.innerHTML = latestAlerts.map(alert => `
        <div class="notification-item">
          <div class="notification-title">${alert.title || 'تنبيه'}</div>
          <div class="notification-message">${alert.message || ''}</div>
          <div class="notification-time">${alert.time || alert.timestamp || 'منذ قليل'}</div>
        </div>
      `).join('');

      // Add subtle animation to show data refresh
      notificationsContainer.style.opacity = '0.7';
      setTimeout(() => {
        notificationsContainer.style.opacity = '1';
      }, 100);
    });
  }

  // 📊 Calculate student progress based on attendance and research submissions
  async function calculateStudentProgress() {
    console.log("[Student Dashboard] Calculating student progress...");
    
    if (!currentEmail) {
      console.log("[Student Dashboard] No current user for progress calculation");
      return 0;
    }

    try {
      const emailKey = currentEmail.replace(/\./g, '_');
      
      // Get user data to get student name for attendance lookup
      const userSnapshot = await database.ref(`users/${emailKey}`).once('value');
      const userData = userSnapshot.val();
      
      if (!userData) {
        console.log("[Student Dashboard] No user data found for progress calculation");
        return 0;
      }

      const studentName = userData.username || userData.name || userData.fullName || userData.firstName;
      console.log("[Student Dashboard] Calculating progress for student:", studentName);

      // Get attendance data
      const attendanceSnapshot = await database.ref('attendance').once('value');
      const attendanceData = attendanceSnapshot.val() || {};
      
      // Get research submissions data
      const researchSnapshot = await database.ref('researches').once('value');
      const researchData = researchSnapshot.val() || {};

      // Calculate attendance progress
      let totalAttendanceDays = 0;
      let presentDays = 0;
      
      Object.values(attendanceData).forEach(dateData => {
        Object.values(dateData).forEach(record => {
          if (record.studentName === studentName || 
              record.studentName?.includes(studentName?.split(' ')[0]) ||
              studentName?.includes(record.studentName?.split(' ')[0])) {
            totalAttendanceDays++;
            if (record.status === 'present') {
              presentDays++;
            }
          }
        });
      });

      // Calculate research submissions progress
      let totalRequiredResearches = 1; // Based on requirement: "one resource of one resource"
      let submittedResearches = 0;
      
      Object.values(researchData).forEach(research => {
        if (research.studentEmail === currentEmail || 
            research.studentName === studentName ||
            research.studentName?.includes(studentName?.split(' ')[0]) ||
            studentName?.includes(research.studentName?.split(' ')[0])) {
          submittedResearches++;
        }
      });

      // Limit submitted researches to required amount
      submittedResearches = Math.min(submittedResearches, totalRequiredResearches);

      // Calculate overall progress based on attendance only
      let attendanceProgress = totalAttendanceDays > 0 ? (presentDays / totalAttendanceDays) : 0;
      let researchProgress = submittedResearches / totalRequiredResearches;

      let overallProgress = attendanceProgress;
      
      // Convert to percentage and cap at 100%
      let progressPercentage = Math.min(Math.round(overallProgress * 100), 100);

      console.log("[Student Dashboard] Progress calculation:", {
        studentName,
        totalAttendanceDays,
        presentDays,
        attendanceProgress: Math.round(attendanceProgress * 100) + '%',
        submittedResearches,
        totalRequiredResearches,
        researchProgress: Math.round(researchProgress * 100) + '%',
        overallProgress: progressPercentage + '%'
      });

      return {
        percentage: progressPercentage,
        attendance: {
          present: presentDays,
          total: totalAttendanceDays,
          percentage: Math.round(attendanceProgress * 100)
        },
        research: {
          submitted: submittedResearches,
          required: totalRequiredResearches,
          percentage: Math.round(researchProgress * 100)
        }
      };

    } catch (error) {
      console.error("[Student Dashboard] Error calculating progress:", error);
      return {
        percentage: 0,
        attendance: { present: 0, total: 0, percentage: 0 },
        research: { submitted: 0, required: 1, percentage: 0 }
      };
    }
  }

  // 📊 Update progress display
  async function updateProgressDisplay() {
    console.log("[Student Dashboard] Updating progress display...");
    
    const progressFill = document.querySelector('.progress-fill');
    const progressText = document.querySelector('.progress-text');
    const studyProgress = document.querySelector('.study-progress');
    const refreshBtn = document.querySelector('.refresh-btn');
    
    // Show loading state
    if (progressText) {
      progressText.textContent = 'جاري حساب التقدم...';
    }
    if (progressFill) {
      progressFill.style.width = '0%';
      progressFill.parentElement.classList.add('loading-progress');
    }
    if (refreshBtn) {
      refreshBtn.style.transform = 'rotate(180deg)';
      refreshBtn.disabled = true;
    }
    
    try {
      const progressData = await calculateStudentProgress();
      
      // Remove loading state
      if (progressFill) {
        progressFill.parentElement.classList.remove('loading-progress');
        
        // Animate progress bar
        setTimeout(() => {
          progressFill.style.width = progressData.percentage + '%';
        }, 200);
      }
      
      if (progressText) {
        // Update progress text with detailed information
        progressText.innerHTML = `${progressData.percentage}% تقدمك في التعلم`;
      }
      
      // Update the description with breakdown
      const progressDescription = studyProgress.querySelector('p');
      if (progressDescription) {
        let statusMessage = '';
        let statusColor = '#666';
        
        if (progressData.percentage >= 90) {
          statusMessage = 'ممتاز! انت ضمن الطلاب الاكثر تفاعل 🎉';
          statusColor = '#388e3c';
        } else if (progressData.percentage >= 75) {
          statusMessage = 'أداء جيد جداً! استمر في المتابعة 👏';
          statusColor = '#2e7d32';
        } else if (progressData.percentage >= 50) {
          statusMessage = 'أداء جيد، يمكنك تحسينه أكثر 💪';
          statusColor = '#f57c00';
        } else {
          statusMessage = 'تحتاج لمزيد من المشاركة والحضور 📚';
          statusColor = '#d32f2f';
        }
        
        progressDescription.innerHTML = `
          <div style="color: ${statusColor}; margin-bottom: 10px; font-weight: bold;">
            ${statusMessage}
          </div>
          <div style="font-size: 0.9em; line-height: 1.6;">
            📊 <strong>تفاصيل التقدم:</strong><br>
            • الحضور: ${progressData.attendance.present} من ${progressData.attendance.total} يوم (${progressData.attendance.percentage}%)
          </div>
        `;
        progressDescription.style.color = '#666';
        progressDescription.style.marginTop = '15px';
      }
      
      console.log("[Student Dashboard] Progress display updated:", progressData);
      
    } catch (error) {
      console.error("[Student Dashboard] Error updating progress display:", error);
      
      if (progressText) {
        progressText.textContent = 'حدث خطأ في حساب التقدم';
      }
      if (progressFill) {
        progressFill.parentElement.classList.remove('loading-progress');
        progressFill.style.width = '0%';
      }
    } finally {
      // Reset refresh button
      if (refreshBtn) {
        setTimeout(() => {
          refreshBtn.style.transform = 'rotate(0deg)';
          refreshBtn.disabled = false;
        }, 500);
      }
    }
  }

  // Debounced version to prevent rapid updates
  const debouncedLoadNotifications = debounce(loadLatestNotifications, 200);
  const debouncedUpdateProgress = debounce(updateProgressDisplay, 500);

  // Mobile menu toggle function
  function toggleMobileMenu() {
    const navMenu = document.getElementById('navMenu');
    navMenu.classList.toggle('active');
  }

  // 🔓 Logout
  function logout() {
      if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        clearSession();
        window.location.href = "index.html";
      }
    }

  // Close mobile menu when clicking on a link
  document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function() {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.remove('active');
      });
    });
  });

  // Clean up listeners when page is unloaded
  window.addEventListener('beforeunload', function() {
    console.log('[Student Dashboard] Cleaning up Firebase listeners...');
    dataCache.cleanup();
  });

  // Performance monitoring
  window.addEventListener('load', function() {
    console.log('[Student Dashboard] Page loaded, cache system active');
  });

// cross background animation
const container = document.querySelector('.cross-background');

  const svgCross = `
  <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!-- License: CC0. Made by SVG Repo: https://www.svgrepo.com/svg/90761/cross -->
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 60 60" style="enable-background:new 0 0 60 60;" xml:space="preserve">
<path d="M52.247,19.665c-0.396,0-0.785,0.049-1.162,0.145c-0.403-2.214-2.347-3.897-4.675-3.897c-2.396,0-4.382,1.781-4.707,4.087
	H35v-4.811c2.077-0.517,3.594-2.381,3.594-4.599c0-2.188-1.486-4.036-3.503-4.586c0.11-0.404,0.167-0.824,0.167-1.251
	C35.258,2.132,33.126,0,30.506,0c-2.621,0-4.753,2.132-4.753,4.753c0,0.395,0.049,0.785,0.145,1.162C23.684,6.318,22,8.262,22,10.59
	c0,2.364,1.735,4.331,4,4.693V20h-7.812c-0.516-2.077-2.38-3.594-4.599-3.594c-2.188,0-4.035,1.486-4.585,3.503
	c-0.405-0.11-0.825-0.167-1.252-0.167C5.132,19.742,3,21.874,3,24.495s2.132,4.753,4.753,4.753c0.396,0,0.785-0.049,1.162-0.145
	C9.318,31.316,11.262,33,13.59,33c2.365,0,4.332-1.736,4.693-4H26v15.84c-2.026,0.551-3.506,2.405-3.506,4.569
	c0,2.188,1.486,4.036,3.502,4.586c-0.11,0.405-0.167,0.825-0.167,1.252c0,2.621,2.132,4.752,4.753,4.752s4.753-2.132,4.753-4.752
	c0-0.395-0.049-0.785-0.146-1.162c2.215-0.404,3.898-2.347,3.898-4.676c0-2.395-1.781-4.382-4.088-4.706V29h6.84
	c0.552,2.027,2.406,3.506,4.57,3.506c2.188,0,4.035-1.486,4.585-3.503c0.405,0.11,0.825,0.167,1.252,0.167
	c2.621,0,4.753-2.132,4.753-4.752S54.868,19.665,52.247,19.665z"/>
</svg>

  `;

 const isMobile = window.innerWidth < 768;
const crossCount = isMobile ? 10 : 25;

for (let i = 0; i < crossCount; i++) {
  const cross = document.createElement('div');
  cross.className = 'cross';
  cross.innerHTML = svgCross;
  cross.style.left = Math.random() * 100 + 'vw';
  cross.style.top = Math.random() * 100 + 'vh';
  cross.style.animationDuration = (12 + Math.random() * 11) + 's';
  container.appendChild(cross);
}
</script>

</body>
</html>